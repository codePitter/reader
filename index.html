<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TotalReader con TTS</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📚</text></svg>">
</head>
<body>

    <div id="notification" class="notification"></div>

    <!-- ─── MAIN PANEL ─── -->
    <div class="main-panel">
        <div class="top-bar">
            <h1>📚 TotalReader</h1>
            <button type="button" class="rec-btn" id="btn-rec-audio" onclick="toggleGrabacion()" style="margin-left:16px;margin-bottom:0;display:none">
                <span id="rec-dot">⏺</span> Grabar audio
            </button>
            <button type="button" class="rec-btn" onclick="abrirvideo()" style="margin-bottom:0;">
                🎬 Modo Video
            </button>
            <button type="button" class="rec-btn" id="btn-rec-video"
                    onclick="(typeof _REC !== 'undefined' && _REC.activo) ? recorder_detener() : recorder_iniciar()"
                    style="margin-bottom:0;display:none">
                🔴 Grabar video
            </button>
            <button type="button" class="rec-btn" onclick="toggleEditor()" id="editor-toggle-btn" style="margin-bottom:0;">
                ✏️ Editor
            </button>
            <button type="button" class="rec-btn export-btn" id="btn-export-video"
                    onclick="exportarVideoDirecto()"
                    disabled
                    title="Exportar capítulo como video">
                🎬 Exportar video
            </button>
            <button type="button" class="rec-btn export-btn" id="btn-export-audio"
                    onclick="abrirModalExportarAudio()"
                    disabled
                    title="Exportar capítulo como audio WAV o MP3">
                🎵 Exportar audio
            </button>
            <span class="subtitle" id="current-chapter-title">Ningún capítulo seleccionado</span>
        </div>

        <div class="stats-bar">
            <div class="stat">📝 Palabras: <strong id="contador-palabras">0</strong></div>
            <div class="stat">🔤 Chars: <strong id="contador-caracteres">0</strong></div>
            <div class="stat">📄 Párrafos: <strong id="contador-parrafos">0</strong></div>
            <div class="stat" id="tts-stat" style="margin-left:auto;">⏹️ <strong id="tts-status">Detenido</strong></div>
            <button type="button"
                    class="btn-copy-reading"
                    onclick="copiarTexto()"
                    title="Copiar todo el texto del capítulo al portapapeles">
                📋 Copiar
            </button>
        </div>

        <!-- ─── BARRA DE CONTROLES TTS ─── -->
        <div class="tts-control-bar">
            <div class="tts-bar-title">Ajustes del lector</div>
            <button type="button" class="btn-tts btn btn-tts-unified" id="btn-play" onclick="togglePlayPause()">▶</button>
            <button type="button" class="btn-tts btn" onclick="detenerTTS()" id="btn-stop" disabled>⏹</button>
            <button id="btn-pause" style="display:none;" disabled></button>
            <button id="btn-resume" style="display:none;" disabled></button>
            <div class="tts-control-bar-sliders">
                <div class="tts-bar-slider">
                    <label>Velocidad <span id="rate-value">1.0</span>x</label>
                    <input type="range" id="rate-control" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
                <div class="tts-bar-slider">
                    <label>Tono <span id="pitch-value">1.0</span></label>
                    <input type="range" id="pitch-control" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>
                <div class="tts-bar-slider">
                    <label>Volumen <span id="volume-value">100</span>%</label>
                    <input type="range" id="volume-control" min="0" max="100" step="5" value="100">
                </div>
            </div>
            <select id="voice-select" class="tts-bar-voice"></select>

            <!-- Botón toggle: usar servidor TTS local para reproducción en vivo -->
            <button type="button"
                    id="btn-tts-servidor-live"
                    class="btn-tts-server-toggle"
                    onclick="toggleServidorLive()"
                    title="Usar servidor TTS local (Edge TTS) para reproducción en vivo">
                🖥 Local
            </button>

            <!-- Selector voz Edge TTS (servidor local) -->
            <select id="edge-voice-select" class="tts-bar-voice tts-bar-voice--server"
                    style="display:none;"
                    onchange="setEdgeTtsVoice(this.value)">
                <optgroup label="🇲🇽 México">
                    <option value="es-MX-JorgeNeural">Jorge — ♂</option>
                    <option value="es-MX-DaliaNeural">Dalia — ♀</option>
                </optgroup>
                <optgroup label="🇦🇷 Argentina">
                    <option value="es-AR-TomasNeural">Tomas — ♂</option>
                    <option value="es-AR-ElenaNeural">Elena — ♀</option>
                </optgroup>
                <optgroup label="🇪🇸 España">
                    <option value="es-ES-AlvaroNeural">Alvaro — ♂</option>
                    <option value="es-ES-ElviraNeural">Elvira — ♀</option>
                    <option value="es-ES-XimenaNeural">Ximena — ♀</option>
                </optgroup>
                <optgroup label="🇨🇴 Colombia">
                    <option value="es-CO-GonzaloNeural">Gonzalo — ♂</option>
                    <option value="es-CO-SalomeNeural">Salome — ♀</option>
                </optgroup>
                <optgroup label="🇺🇸 EEUU">
                    <option value="es-US-AlonsoNeural">Alonso — ♂</option>
                    <option value="es-US-PalomaNeural">Paloma — ♀</option>
                </optgroup>
                <optgroup label="🇨🇱 Chile">
                    <option value="es-CL-LorenzoNeural">Lorenzo — ♂</option>
                    <option value="es-CL-CatalinaNeural">Catalina — ♀</option>
                </optgroup>
                <optgroup label="🇵🇪 Perú">
                    <option value="es-PE-AlexNeural">Alex — ♂</option>
                    <option value="es-PE-CamilaNeural">Camila — ♀</option>
                </optgroup>
                <optgroup label="🇻🇪 Venezuela">
                    <option value="es-VE-SebastianNeural">Sebastian — ♂</option>
                    <option value="es-VE-PaolaNeural">Paola — ♀</option>
                </optgroup>
                <optgroup label="🇺🇾 Uruguay">
                    <option value="es-UY-MateoNeural">Mateo — ♂</option>
                    <option value="es-UY-ValentinaNeural">Valentina — ♀</option>
                </optgroup>
                <optgroup label="🇵🇾 Paraguay">
                    <option value="es-PY-MarioNeural">Mario — ♂</option>
                    <option value="es-PY-TaniaNeural">Tania — ♀</option>
                </optgroup>
                <optgroup label="🇧🇴 Bolivia">
                    <option value="es-BO-MarceloNeural">Marcelo — ♂</option>
                    <option value="es-BO-SofiaNeural">Sofia — ♀</option>
                </optgroup>
                <optgroup label="🇪🇨 Ecuador">
                    <option value="es-EC-LuisNeural">Luis — ♂</option>
                    <option value="es-EC-AndreaNeural">Andrea — ♀</option>
                </optgroup>
                <optgroup label="🇩🇴 R. Dominicana">
                    <option value="es-DO-EmilioNeural">Emilio — ♂</option>
                    <option value="es-DO-RamonaNeural">Ramona — ♀</option>
                </optgroup>
                <optgroup label="🇨🇺 Cuba">
                    <option value="es-CU-ManuelNeural">Manuel — ♂</option>
                    <option value="es-CU-BelkysNeural">Belkys — ♀</option>
                </optgroup>
                <optgroup label="🇨🇷 Costa Rica">
                    <option value="es-CR-JuanNeural">Juan — ♂</option>
                    <option value="es-CR-MariaNeural">Maria — ♀</option>
                </optgroup>
                <optgroup label="🇵🇦 Panamá">
                    <option value="es-PA-RobertoNeural">Roberto — ♂</option>
                    <option value="es-PA-MargaritaNeural">Margarita — ♀</option>
                </optgroup>
                <optgroup label="🇸🇻 El Salvador">
                    <option value="es-SV-RodrigoNeural">Rodrigo — ♂</option>
                    <option value="es-SV-LorenaNeural">Lorena — ♀</option>
                </optgroup>
                <optgroup label="🇬🇹 Guatemala">
                    <option value="es-GT-AndresNeural">Andres — ♂</option>
                    <option value="es-GT-MartaNeural">Marta — ♀</option>
                </optgroup>
                <optgroup label="🇭🇳 Honduras">
                    <option value="es-HN-CarlosNeural">Carlos — ♂</option>
                    <option value="es-HN-KarlaNeural">Karla — ♀</option>
                </optgroup>
                <optgroup label="🇳🇮 Nicaragua">
                    <option value="es-NI-FedericoNeural">Federico — ♂</option>
                    <option value="es-NI-YolandaNeural">Yolanda — ♀</option>
                </optgroup>
                <optgroup label="🇵🇷 Puerto Rico">
                    <option value="es-PR-VictorNeural">Victor — ♂</option>
                    <option value="es-PR-KarinaNeural">Karina — ♀</option>
                </optgroup>
                <optgroup label="🇬🇶 Guinea Ecuatorial">
                    <option value="es-GQ-JavierNeural">Javier — ♂</option>
                    <option value="es-GQ-TeresaNeural">Teresa — ♀</option>
                </optgroup>
            </select>
        </div>

        <div class="reading-area" style="position:relative;">
            <div id="texto-contenido" style="font-family:'Lora',serif;font-size:1.1rem;line-height:1.85;color:var(--text);max-width:680px;margin:0 auto;white-space:pre-wrap;">
                <p style="color:var(--text-dim);font-style:italic;">Carga un archivo EPUB desde el panel lateral para comenzar a leer...</p>
            </div>
            <!-- Música ambiental flotante anclada a esquina inferior izquierda del reading area -->
        </div><!-- cierre reading-area -->
        <!-- ─── AMBIENT MUSIC PLAYER ─── -->
        <div id="ambient-player" class="collapsed">
            <div class="ambient-header" onclick="toggleAmbientPanel()">
                <div class="ambient-header-left">
                    <div class="ambient-eq" id="ambient-eq">
                        <span></span><span></span><span></span><span></span>
                    </div>
                    Música Ambiental
                </div>
                <button type="button" class="ambient-collapse-btn" id="ambient-arrow">▶</button>
            </div>
            <div class="ambient-body">

                <!-- API Key panel -->
                <div id="freesound-key-panel" style="margin-bottom:10px;">
                    <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">
                        🎵 Freesound API Key <span style="color:var(--accent2)" id="key-status"></span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <input type="password" id="freesound-api-key" placeholder="Pegar API key..."
                               style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;
                    color:var(--text);font-family:'DM Mono',monospace;font-size:0.62rem;padding:5px 8px;outline:none;">
                        <button type="button" onclick="guardarApiKey()"
                                style="background:var(--accent2);border:none;border-radius:4px;color:var(--bg);
                    font-family:'DM Mono',monospace;font-size:0.6rem;padding:5px 8px;cursor:pointer;">
                            OK
                        </button>
                    </div>
                    <div style="font-size:0.55rem;color:var(--text-dim);margin-top:3px;">
                        Sin key → generador procedural local
                    </div>
                </div>

                <div class="ambient-genres">
                    <button type="button" class="genre-btn" onclick="selectGenre('mystery')" id="genre-mystery">
                        <span class="genre-icon">🔍</span>Misterio
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('suspense')" id="genre-suspense">
                        <span class="genre-icon">😰</span>Suspenso
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('drama')" id="genre-drama">
                        <span class="genre-icon">🎭</span>Drama
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('action')" id="genre-action">
                        <span class="genre-icon">⚡</span>Acción
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('fantasy')" id="genre-fantasy">
                        <span class="genre-icon">🧙</span>Fantasía
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('romance')" id="genre-romance">
                        <span class="genre-icon">💫</span>Romance
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('lofi')" id="genre-lofi">
                        <span class="genre-icon">📚</span>Lo-Fi
                    </button>
                    <button type="button" class="genre-btn" onclick="selectGenre('nature')" id="genre-nature">
                        <span class="genre-icon">🌿</span>Naturaleza
                    </button>
                </div>

                <button type="button" class="btn btn-secondary" onclick="detectarGeneroConIA()" id="btn-detect-genre"
                        style="width:100%;margin-bottom:10px;font-size:0.62rem;gap:6px;">
                    ✨ Detectar género del texto
                </button>

                <div class="ambient-controls">
                    <button type="button" class="ambient-play-btn" id="ambient-play-btn" onclick="toggleAmbientPlay()">▶</button>
                    <div class="ambient-track-info">
                        <div class="ambient-track-name" id="ambient-track-name">Selecciona un género</div>
                        <div class="ambient-track-genre" id="ambient-track-genre">─</div>
                    </div>
                    <button type="button" onclick="siguienteTrack()" title="Siguiente track"
                            style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:0.9rem;padding:4px;transition:color 0.2s;"
                            onmouseover="this.style.color='var(--accent)'"
                            onmouseout="this.style.color='var(--text-dim)'">
                        ⏭
                    </button>
                </div>

                <div class="ambient-vol-row">
                    <span class="ambient-vol-icon">🎵</span>
                    <input type="range" id="ambient-volume" min="0" max="100" value="15" oninput="setAmbientVolume(this.value)">
                    <span class="ambient-vol-val" id="ambient-vol-val">15%</span>
                </div>
            </div>
        </div><!-- cierre ambient-player -->
        <!-- Barra de procesamiento con fases — visible en el reading area al procesar -->
        <div id="main-processing-bar" style="display:none;flex-direction:column;align-items:stretch;gap:6px;padding:10px 28px 12px;background:var(--surface2);border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                <span id="mpb-label" style="font-size:0.7rem;color:var(--accent2);font-family:'DM Mono',monospace;font-style:italic;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Procesando...</span>
                <span id="mpb-pct" style="font-size:0.65rem;color:var(--text-dim);font-family:'DM Mono',monospace;flex-shrink:0;">0%</span>
            </div>
            <!-- Barra unificada -->
            <div style="height:4px;background:var(--border);border-radius:4px;overflow:hidden;">
                <div id="mpb-fill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;transition:width 0.5s ease;"></div>
            </div>
            <!-- Indicadores de fase -->
            <div style="display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--text-dim);margin-top:1px;">
                <span id="mpb-f1" style="transition:color 0.3s;">① Traducción</span>
                <span id="mpb-f2" style="transition:color 0.3s;">② Revisión</span>
                <span id="mpb-f3" style="transition:color 0.3s;">③ Optimización</span>
            </div>
        </div>

        <div class="editor-panel" id="editor-panel">
            <div class="editor-inner">
                <div class="section-label">Editor de Texto</div>
                <textarea id="editor-texto" placeholder="Pega aquí tu texto o edita el contenido actual..."></textarea>
                <div class="editor-actions">
                    <button type="button" class="btn btn-success" onclick="aplicarTexto()">Aplicar</button>
                    <button type="button" class="btn btn-secondary" onclick="limpiarEditor()">Limpiar</button>
                    <button type="button" class="btn btn-secondary" onclick="copiarTexto()">Copiar</button>
                    <button type="button" class="btn btn-secondary" onclick="traducirTextoActual()" style="margin-left:auto;">Traducir</button>
                </div>
            </div>
        </div>

        <span id="tts-status-label" style="display:none;"></span>

        <div class="progress-wrap">
            <div class="progress-track" id="main-progress-track"
                 onclick="seekTTS(event)"
                 onmousemove="mainProgressMouseMove(event)"
                 onmouseleave="mainProgressMouseLeave()">
                <div class="progress-fill" id="progress-fill"></div>
                <div id="main-progress-tooltip"></div>
            </div>
        </div>
    </div>

    <!-- ─── SIDEBAR ─── -->
    <div class="sidebar">

        <!-- Cargar archivo -->
        <div class="sidebar-section">
            <div class="section-label">Archivo</div>
            <label for="epub-file" class="file-label">📂 Seleccionar archivo</label>
            <input type="file" id="epub-file" accept=".epub,.txt,.html,.htm,.pdf,.fb2,.fb3,.docx,.rtf,.odt,.mobi,.prc,.azw3,.azw,.cbz,.cbr" data-default-dir="documents">
            <span id="file-name">Ningún archivo seleccionado</span>
            <div id="formats-hint" style="font-size:0.52rem;color:var(--text-dim);margin-top:4px;line-height:1.5;opacity:0.6;">
                epub · txt · pdf · docx · html · fb2 · odt · rtf · mobi · cbz…
            </div>
        </div>

        <!-- Capítulos -->
        <div class="sidebar-section">
            <div class="section-label">Capítulos</div>
            <!-- Chip del capítulo activo (visible cuando el selector está colapsado) -->
            <div id="chapter-active-chip" style="display:none;align-items:center;gap:6px;
                 background:var(--surface2);border:1px solid var(--border);border-radius:5px;
                 padding:5px 9px;cursor:pointer;font-size:0.68rem;font-family:'DM Mono',monospace;
                 color:var(--text);transition:border-color 0.2s;"
                 title="Click para cambiar capítulo"
                 onclick="expandirSelectorCapitulos()"
                 onmouseover="this.style.borderColor='var(--accent)'"
                 onmouseout="this.style.borderColor='var(--border)'">
                <span id="chapter-active-chip-text" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">—</span>
                <span id="chapter-chip-arrow" style="color:var(--accent);font-size:0.7rem;flex-shrink:0;" title="Click para expandir">▲</span>
            </div>
            <div id="chapter-selector" style="display:none;">
                <input type="text" id="chapter-search" placeholder="🔍 Buscar capítulo..."
                       oninput="filtrarCapitulos(this.value)"
                       style="width:100%;margin-bottom:6px;font-size:0.68rem;padding:6px 10px;
                              background:var(--bg);border:1px solid var(--border);border-radius:4px;
                              color:var(--text);font-family:'DM Mono',monospace;outline:none;">
                <select id="chapters" size="6" ondblclick="colapsarSelectorCapitulos()">
                    <option disabled>— sin capítulos —</option>
                </select>
            </div>
        </div>

        <!-- ═══════════════ AJUSTES ═══════════════ -->
        <div class="sidebar-section">
            <div class="section-label">Ajustes</div>


            <!-- ── Imágenes: selector movido a la barra del visor de video ── -->
            <!-- IDs necesarios por JS — ocultos, sin UI en sidebar -->
            <div style="display:none;">
                <div id="imagen-ia-body">
                    <div id="ia-options-body">
                        <div id="ia-prov-body">
                            <input type="radio" name="img-provider" value="puter" id="prov-puter" onchange="setImageProvider('puter')">
                            <input type="radio" name="img-provider" value="stability" id="prov-stability" onchange="setImageProvider('stability')">
                            <input type="radio" name="img-provider" value="pollinations" id="prov-pollinations" onchange="setImageProvider('pollinations')">
                            <input type="radio" name="img-provider" value="procedural" id="prov-procedural" onchange="setImageProvider('procedural')">
                            <input type="radio" name="img-provider" value="pixabay" id="prov-pixabay" onchange="setImageProvider('pixabay')">
                            <input type="radio" name="img-provider" value="picsum" id="prov-picsum" onchange="setImageProvider('picsum')" checked>
                            <div id="puter-panel">
                                <select id="puter-model" onchange="puterModel=this.value;localStorage.setItem('puter_model',this.value);">
                                    <optgroup label="── GPT Image ──"><option value="gpt-image-1.5">GPT Image 1.5 (recomendado)</option><option value="gpt-image-1">GPT Image 1</option><option value="dall-e-3">DALL-E 3</option></optgroup>
                                    <optgroup label="── FLUX ──"><option value="black-forest-labs/FLUX.1-schnell-Free">FLUX.1 Schnell</option><option value="black-forest-labs/FLUX.1-pro">FLUX.1 Pro</option><option value="black-forest-labs/FLUX.1.1-pro">FLUX.1.1 Pro</option><option value="black-forest-labs/FLUX.1-dev">FLUX.1 Dev</option></optgroup>
                                    <optgroup label="── Stable Diffusion ──"><option value="stabilityai/stable-diffusion-3-medium">SD3 Medium</option><option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL Base</option></optgroup>
                                    <optgroup label="── Otros ──"><option value="ideogram/ideogram-3.0">Ideogram 3.0</option><option value="grok-2-image">Grok 2 (xAI)</option><option value="google/imagen-4.0-fast">Imagen 4.0 Fast</option><option value="gemini-2.5-flash-image-preview">Gemini 2.5 Flash</option></optgroup>
                                </select>
                            </div>
                            <div id="stability-panel">
                                <input type="password" id="stability-api-key" placeholder="sk-...">
                                <button type="button" onclick="guardarStabilityKey()">OK</button>
                                <span id="stability-key-status"></span>
                                <select id="stability-model" onchange="stabilityModel=this.value;localStorage.setItem('stability_model',this.value);">
                                    <option value="sd3.5-large">SD3.5 Large</option>
                                    <option value="sd3.5-large-turbo">SD3.5 Turbo</option>
                                    <option value="sd3.5-medium" selected>SD3.5 Medium</option>
                                    <option value="core">Stable Image Core</option>
                                    <option value="ultra">Stable Image Ultra</option>
                                </select>
                            </div>
                            <div id="pollinations-panel"></div>
                            <div id="procedural-panel"></div>
                            <div id="pixabay-video-panel"></div>
                            <div id="picsum-panel"></div>
                        </div>
                    </div>
                    <div id="img-ia-status-txt"></div>
                    <div id="ia-web-body">
                        <div id="img-universe-badge"><span id="img-universe-label"></span></div>
                        <input type="text" id="img-search-input">
                        <div id="imagen-ia-galeria"></div>
                    </div>
                </div>
            </div>
            <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);">
                <div class="toggle-row" style="margin-bottom:4px;">
                    <span style="display:flex;flex-direction:column;gap:1px;">
                        <span>Traducción automática</span>
                        <span style="font-size:0.68rem;color:var(--text-dim);" id="traduccion-lang-hint">→ detectando idioma...</span>
                    </span>
                    <label class="toggle">
                        <input type="checkbox" id="auto-translate" onchange="marcarCambioPendiente()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <!-- Selector de idioma destino: todas las opciones que soporta el navegador -->
                <div style="margin:6px 0 4px 0;">
                    <div style="font-size:0.6rem;color:var(--text-dim);margin-bottom:3px;">Traducir a:</div>
                    <select id="translation-lang-select"
                            onchange="cambiarIdiomaTraduccion(this.value)"
                            style="width:100%;background:var(--bg);border:1px solid var(--border);
                                   border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;
                                   font-size:0.62rem;padding:5px 8px;outline:none;cursor:pointer;">
                        <!-- Poblado por JS con los idiomas del navegador -->
                    </select>
                </div>
                <div id="translation-status">Traducción desactivada</div>
            </div>

            <!-- ── Naturalizar para TTS ── -->
            <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);">
                <div class="toggle-row">
                    <span style="display:flex;flex-direction:column;gap:2px;">
                        <span>✨ Naturalizar para TTS</span>
                        <span style="font-size:0.7rem;color:var(--text-dim);" id="humanizer-status">Desactivado</span>
                    </span>
                    <label class="toggle">
                        <input type="checkbox" id="tts-humanizer" onchange="toggleTTSHumanizer()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="claude-key-panel" style="margin-top:6px;display:none;">
                    <select id="humanizer-provider" onchange="cambiarProveedorHumanizer(this.value)"
                            style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;
                                   color:var(--text);font-family:'DM Mono',monospace;font-size:0.62rem;
                                   padding:5px 8px;outline:none;cursor:pointer;margin-bottom:6px;">
                        <option value="perplexity">Perplexity AI (sonar)</option>
                        <option value="openai">OpenAI (gpt-4o-mini)</option>
                        <option value="anthropic">Anthropic (claude-haiku)</option>
                        <option value="gemini">Google Gemini (flash)</option>
                        <option value="groq">Groq (llama-3.3-70b)</option>
                        <option value="openrouter">OpenRouter (auto)</option>
                    </select>
                    <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">
                        🔑 API Key <span style="color:var(--accent2)" id="claude-key-status"></span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <input type="password" id="claude-api-key" placeholder="Pega tu API key..."
                               style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;
                               color:var(--text);font-family:'DM Mono',monospace;font-size:0.62rem;padding:5px 8px;outline:none;">
                        <button type="button" onclick="guardarClaudeApiKey()"
                                style="background:var(--accent);border:none;border-radius:4px;color:var(--bg);
                                font-family:'DM Mono',monospace;font-size:0.6rem;padding:5px 8px;cursor:pointer;">
                            OK
                        </button>
                    </div>
                    <div style="font-size:0.55rem;color:var(--text-dim);margin-top:3px;" id="humanizer-info">
                        Procesa ~2500 chars por bloque · puede tardar unos segundos
                    </div>
                </div>
            </div>

            <!-- ── Reproducir al terminar ── -->
            <div class="toggle-row" id="auto-play-row" style="display:none;">
                <span>▶ Reproducir al terminar</span>
                <label class="toggle">
                    <input type="checkbox" id="auto-play-after-translate" onchange="marcarCambioPendiente()" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ── Auto siguiente capítulo ── -->
            <div class="toggle-row" style="margin-top:6px;">
                <span style="display:flex;flex-direction:column;gap:1px;">
                    <span>⏭ Siguiente capítulo auto</span>
                    <span style="font-size:0.62rem;color:var(--text-dim);">Al terminar, carga el siguiente</span>
                </span>
                <label class="toggle">
                    <input type="checkbox" id="auto-next-chapter" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <!-- ── Botón Aplicar ── -->
            <div id="aplicar-row" style="display:none;margin-top:10px;">
                <button type="button" id="btn-aplicar" onclick="aplicarConfiguracion()"
                        style="width:100%;background:var(--accent);border:none;border-radius:6px;
                               color:var(--bg);font-family:'DM Mono',monospace;font-size:0.72rem;
                               font-weight:700;padding:8px 0;cursor:pointer;letter-spacing:0.03em;
                               transition:opacity 0.2s;">
                    ✓ Aplicar
                </button>
                <div style="font-size:0.55rem;color:var(--text-dim);text-align:center;margin-top:3px;" id="aplicar-hint">
                    Cambios pendientes — recarga el capítulo actual
                </div>
            </div>
        </div>

        <!-- Reemplazar palabras -->
        <div class="sidebar-section">
            <div class="section-label collapsible-label" onclick="toggleReemplazar()" style="cursor:pointer;user-select:none;display:flex;align-items:center;">
                Reemplazar
                <span id="reemplazar-arrow" style="margin-left:auto;font-size:0.7rem;color:var(--text-dim);">▶</span>
                <button type="button" onclick="event.stopPropagation();abrirModalReemplazos()" title="Ver reemplazos activos"
                        style="margin-left:6px;background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-size:0.58rem;padding:1px 5px;cursor:pointer;line-height:1.4;transition:color 0.2s,border-color 0.2s;"
                        onmouseover="this.style.color='var(--accent)';this.style.borderColor='var(--accent)'"
                        onmouseout="this.style.color='var(--text-dim)';this.style.borderColor='var(--border)'">
                    📋
                </button>
            </div>
            <div class="replace-pair" id="reemplazar-body" style="display:none;">
                <input type="text" id="palabra-buscar" placeholder="Buscar...">
                <input type="text" id="palabra-reemplazar" placeholder="Reemplazar con...">
                <div style="display:flex;gap:6px;">
                    <button type="button" class="btn btn-secondary" id="btn-limpiar-reemplazos" onclick="limpiarReemplazosGuardados()" style="flex:1;font-size:0.62rem;" disabled>🗑 Limpiar</button>
                    <button type="button" class="btn btn-primary" onclick="reemplazarPalabra()" style="flex:1;">Reemplazar</button>
                </div>
                <div id="reemplazos-guardados-lista" style="display:none;margin-top:6px;max-height:90px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;"></div>
            </div>
        </div>



    </div>


    <!-- ─── FOOTER ─── -->
    <footer class="app-footer">
        <span>© 2025 TotalReader</span>
        <span class="footer-sep">·</span>
        <span>Desarrollado por <strong style="color:var(--accent);">hpqode</strong></span>
        <span class="footer-sep">·</span>
        <a href="mailto:pitterbck@gmail.com" title="Contacto por email">Email</a>
        <span class="footer-sep">·</span>
        <a href="https://wa.me/5493412282254" target="_blank" rel="noopener" title="WhatsApp">WhatsApp</a>
    </footer>


    <!-- ─── VIDEO OVERLAY ─── -->
    <div id="video-overlay">
        <div id="ai-bg-a" style="position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity 1.2s ease;pointer-events:none;z-index:0;"></div>
        <div id="ai-bg-b" style="position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity 1.2s ease;pointer-events:none;z-index:0;"></div>
        <div id="ai-bg-overlay" style="position:absolute;inset:0;background:rgba(8,7,6,0);transition:background 1s ease;pointer-events:none;z-index:1;"></div>
        <canvas id="video-canvas" style="position:absolute;inset:0;width:100%;height:100%;z-index:2;pointer-events:auto;display:block;cursor:pointer;"></canvas>

        <div id="video-progress-wrap">
            <div id="video-progress-track"
                 onmouseenter="this.style.height='8px'"
                 onmouseleave="this.style.height='4px';videoProgressHover(false)"
                 onmousemove="videoProgressMouseMove(event)"
                 onclick="videoProgressSeek(event)">
                <div id="video-progress-fill"></div>
                <div id="video-seek-tooltip"></div>
            </div>
        </div>

        <div class="video-bar">
            <button id="kbtn-playpause" onclick="videoTogglePlay()" style="background:none;border:none;color:var(--accent);font-size:1.3rem;cursor:pointer;padding:0 2px;line-height:1;flex-shrink:0;">&#9654;</button>
            <button onclick="videoCapituloAnterior()" style="background:none;border:none;color:var(--text-dim);font-size:0.85rem;cursor:pointer;padding:0 2px;flex-shrink:0;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#9198;</button>
            <button onclick="videoCapituloSiguiente()" style="background:none;border:none;color:var(--text-dim);font-size:0.85rem;cursor:pointer;padding:0 2px;flex-shrink:0;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#9197;</button>
            <span id="kp-current" style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text-dim);flex-shrink:0;white-space:nowrap;">&#8212;</span>
            <span id="kp-chapter" style="font-family:'Lora',serif;font-size:0.68rem;color:var(--text-dim);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
            <span style="font-size:0.7rem;color:var(--text-dim);flex-shrink:0;" title="Volumen general">&#128266;</span>
            <input type="range" id="kol-tts-vol" min="0" max="100" value="100" oninput="setTTSVolume(this.value);document.getElementById('kol-tts-pct').textContent=this.value+'%'" style="width:64px;accent-color:var(--accent);flex-shrink:0;cursor:pointer;">
            <span id="kol-tts-pct" style="font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--text-dim);flex-shrink:0;min-width:28px;">100%</span>
            <!-- Music popup button -->
            <div style="position:relative;flex-shrink:0;" id="video-music-wrapper">
                <button id="kbtn-music-popup" onclick="_toggleMusicMenu()"
                        style="background:none;border:1px solid var(--border);border-radius:4px;
                               color:var(--text-dim);font-size:0.58rem;padding:2px 6px;cursor:pointer;
                               display:flex;align-items:center;gap:3px;white-space:nowrap;
                               transition:color 0.2s,border-color 0.2s;"
                        onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'"
                        onmouseout="if(!document.getElementById('video-music-menu').classList.contains('open')){this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'}">
                    🎵 <span id="video-music-label" style="max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Música</span>
                    <span id="kbtn-ambient-indicator" style="font-size:0.5rem;color:var(--accent2);">●</span> ▾
                </button>
                <!-- Popup hacia arriba -->
                <div id="video-music-menu"
                     style="display:none;position:absolute;bottom:calc(100% + 6px);left:0;
                            background:var(--surface2);border:1px solid var(--border);border-radius:6px;
                            padding:8px;min-width:220px;z-index:300;box-shadow:0 -4px 20px rgba(0,0,0,0.7);">
                    <!-- Controles de playback -->
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid var(--border);">
                        <button id="kbtn-ambient-mute" onclick="toggleAmbientMute()" style="background:none;border:none;color:var(--text-dim);font-size:1rem;cursor:pointer;padding:0;transition:color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#128266;</button>
                        <button onclick="videoMusicaPrev()" style="background:none;border:none;color:var(--text-dim);font-size:0.85rem;cursor:pointer;padding:0;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#9664;</button>
                        <button id="kbtn-ambient-playpause" onclick="videoToggleAmbient()" style="background:none;border:none;color:var(--accent);font-size:1.1rem;cursor:pointer;padding:0;">&#9654;</button>
                        <button onclick="videoMusicaSiguiente()" style="background:none;border:none;color:var(--text-dim);font-size:0.85rem;cursor:pointer;padding:0;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#9654;</button>
                        <button id="kbtn-ambient-loop" onclick="toggleAmbientLoop()" title="Loop música" style="background:none;border:none;color:var(--text-dim);font-size:0.85rem;cursor:pointer;padding:0;transition:color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="if(!window._ambientLoopOn){this.style.color='var(--text-dim)'}">🔁</button>
                        <div style="flex:1;min-width:0;">
                            <div style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" id="video-music-label-full">─</div>
                            <div style="font-size:0.52rem;color:var(--text-dim);" id="video-music-genre-label">─</div>
                        </div>
                    </div>
                    <!-- Volumen -->
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid var(--border);">
                        <span style="font-size:0.58rem;color:var(--text-dim);flex-shrink:0;">Vol</span>
                        <input type="range" id="kol-music-vol" min="0" max="100" value="15"
                               oninput="setAmbientVolume(this.value);document.getElementById('kol-music-pct').textContent=this.value+'%';document.getElementById('ambient-vol-val').textContent=this.value+'%'"
                               style="flex:1;accent-color:var(--accent);cursor:pointer;">
                        <span id="kol-music-pct" style="font-family:'DM Mono',monospace;font-size:0.58rem;color:var(--text-dim);min-width:28px;">15%</span>
                    </div>
                    <!-- Géneros -->
                    <div style="font-size:0.56rem;color:var(--text-dim);letter-spacing:0.05em;text-transform:uppercase;margin-bottom:5px;">Género</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;" id="video-genre-grid">
                        <button onclick="selectGenre('mystery');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">🔍 Misterio</button>
                        <button onclick="selectGenre('suspense');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">😰 Suspenso</button>
                        <button onclick="selectGenre('fantasy');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">🧙 Fantasía</button>
                        <button onclick="selectGenre('action');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">⚡ Acción</button>
                        <button onclick="selectGenre('drama');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">🎭 Drama</button>
                        <button onclick="selectGenre('romance');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">💫 Romance</button>
                        <button onclick="selectGenre('lofi');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">📚 Lo-Fi</button>
                        <button onclick="selectGenre('nature');_actualizarMusicLabel()" style="background:none;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:0.58rem;padding:3px 0;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">🌿 Naturaleza</button>
                    </div>
                </div>
            </div>
            <!-- Selector de proveedor de imágenes — popup sobre el botón -->
            <div style="position:relative;flex-shrink:0;" id="img-prov-wrapper">
                <button id="btn-img-prov" onclick="_toggleImgProvMenu()"
                        style="background:none;border:1px solid var(--border);border-radius:4px;
                               color:var(--text-dim);font-size:0.58rem;padding:2px 6px;cursor:pointer;
                               white-space:nowrap;transition:color 0.2s,border-color 0.2s;display:flex;align-items:center;gap:3px;"
                        onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'"
                        onmouseout="if(!document.getElementById('img-prov-menu').classList.contains('open')){this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'}">
                    🖼 <span id="btn-img-prov-label">Picsum</span> ▾
                </button>
                <!-- Menú desplegable -->
                <div id="img-prov-menu"
                     style="display:none;position:absolute;bottom:calc(100% + 6px);left:0;
                            background:var(--surface2);border:1px solid var(--border);border-radius:6px;
                            padding:8px;min-width:220px;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.6);">
                    <div style="font-size:0.58rem;color:var(--text-dim);letter-spacing:0.05em;text-transform:uppercase;margin-bottom:6px;">Fuente de imágenes</div>
                    <!-- Opciones -->
                    <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:8px;" id="img-prov-options">
                        <label id="opt-picsum" class="img-prov-opt img-prov-active"><span class="img-prov-dot"></span> 🌄 Picsum       <small>(sin key, gratis)</small></label>
                        <label id="opt-pexels" class="img-prov-opt"><span class="img-prov-dot"></span> 🖼 Pexels        <small>(fotos HD, gratis)</small></label>
                        <label id="opt-pixabay" class="img-prov-opt"><span class="img-prov-dot"></span> 📷 Pixabay       <small>(fotos reales)</small></label>
                        <label id="opt-openverse" class="img-prov-opt"><span class="img-prov-dot"></span> 🌐 Openverse     <small>(CC0, sin key)</small></label>
                        <label id="opt-puter" class="img-prov-opt"><span class="img-prov-dot"></span> 🤖 Puter.js      <small>(IA generativa)</small></label>
                        <label id="opt-pollinations" class="img-prov-opt"><span class="img-prov-dot"></span> ✨ Pollinations  <small>(IA, gratis)</small></label>
                        <label id="opt-procedural" class="img-prov-opt"><span class="img-prov-dot"></span> 🎨 Procedural    <small>(sin internet)</small></label>
                    </div>

                    <!-- Helper: fila de frecuencia reutilizable -->
                    <!-- Picsum frecuencia -->
                    <div id="picsum-freq-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.56rem;color:var(--text-dim);margin-bottom:5px;">🌄 Sin API key · imágenes aleatorias</div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-picsum-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('picsum',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('picsum',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Pexels key + frecuencia -->
                    <div id="pexels-key-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">
                            🔑 Pexels API Key
                            <span id="pexels-key-status-video" style="color:var(--accent2);margin-left:4px;"></span>
                        </div>
                        <div style="display:flex;gap:4px;">
                            <input type="password" id="pexels-key-input-video" placeholder="tu-api-key-pexels"
                                   style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:4px 6px;outline:none;min-width:0;">
                            <button type="button" onclick="guardarPexelsKeyVideo()"
                                    style="background:var(--accent2);border:none;border-radius:4px;color:var(--bg);font-family:'DM Mono',monospace;font-size:0.6rem;padding:4px 8px;cursor:pointer;flex-shrink:0;">
                                OK
                            </button>
                        </div>
                        <div style="font-size:0.52rem;color:var(--text-dim);margin-top:4px;line-height:1.3;">
                            Key gratuita en <a href="https://www.pexels.com/api/key/" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;">pexels.com/api/key</a>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-pexels-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('pexels',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('pexels',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Pixabay key + frecuencia -->
                    <div id="pixabay-key-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">
                            🔑 Pixabay API Key
                            <span id="pixabay-key-status-video" style="color:var(--accent2);margin-left:4px;"></span>
                        </div>
                        <div style="display:flex;gap:4px;">
                            <input type="password" id="pixabay-key-input-video" placeholder="tu-api-key-aquí"
                                   style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:4px 6px;outline:none;min-width:0;">
                            <button type="button" onclick="guardarPixabayKeyVideo()"
                                    style="background:var(--accent2);border:none;border-radius:4px;color:var(--bg);font-family:'DM Mono',monospace;font-size:0.6rem;padding:4px 8px;cursor:pointer;flex-shrink:0;">
                                OK
                            </button>
                        </div>
                        <div style="font-size:0.52rem;color:var(--text-dim);margin-top:4px;line-height:1.3;">
                            Sin key → fotos aleatorias (Picsum).<br>
                            Key gratis en <a href="https://pixabay.com/api/docs/" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none;">pixabay.com/api/docs</a>
                        </div>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-pixabay-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('pixabay',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('pixabay',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Openverse frecuencia -->
                    <div id="openverse-key-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.56rem;color:var(--text-dim);margin-bottom:5px;">🌐 Sin API key · 800M imágenes CC0</div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-openverse-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('openverse',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('openverse',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Puter model + frecuencia -->
                    <div id="puter-key-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">Modelo Puter.js</div>
                        <select id="puter-model-pop" onchange="puterModel=this.value;localStorage.setItem('puter_model',this.value);document.getElementById('puter-model').value=this.value;"
                                style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:4px 6px;">
                            <option value="gpt-image-1.5">GPT Image 1.5 (recomendado)</option>
                            <option value="gpt-image-1">GPT Image 1</option>
                            <option value="dall-e-3">DALL-E 3</option>
                            <option value="black-forest-labs/FLUX.1-schnell-Free">FLUX.1 Schnell</option>
                            <option value="black-forest-labs/FLUX.1-pro">FLUX.1 Pro</option>
                            <option value="google/imagen-4.0-fast">Imagen 4.0 Fast</option>
                        </select>
                        <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-puter-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('puter',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('puter',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Pollinations frecuencia -->
                    <div id="pollinations-freq-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.56rem;color:var(--text-dim);margin-bottom:5px;">✨ IA generativa · sin API key</div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-pollinations-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('pollinations',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('pollinations',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <!-- Procedural frecuencia -->
                    <div id="procedural-freq-popover" style="display:none;border-top:1px solid var(--border);padding-top:7px;margin-top:2px;">
                        <div style="font-size:0.56rem;color:var(--text-dim);margin-bottom:5px;">🎨 Generado localmente · sin internet</div>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:0.54rem;color:var(--text-dim);white-space:nowrap;">⏱ Cambiar cada</span>
                            <input type="number" min="1" max="200" id="freq-procedural-pop"
                                   style="width:42px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:3px 5px;outline:none;text-align:center;"
                                   onblur="guardarFrecuenciaImagen('procedural',this)" onkeydown="if(event.key==='Enter')guardarFrecuenciaImagen('procedural',this)">
                            <span style="font-size:0.54rem;color:var(--text-dim);">frases</span>
                        </div>
                    </div>

                    <div style="font-size:0.52rem;color:var(--text-dim);margin-top:6px;" id="img-prov-status-pop"></div>
                </div>
            </div>
            <button id="btn-toggle-ai-img" onclick="toggleAIImages()" class="vbar-btn">&#128444; IA</button>
            <button id="btn-toggle-grayscale" onclick="toggleImageGrayscale()" title="Escala de grises" class="vbar-btn">⬜ B&W</button>
            <button id="btn-toggle-index" onclick="togglevideoIndex()" style="background:none;border:none;color:var(--text-dim);font-size:0.9rem;cursor:pointer;padding:0 2px;flex-shrink:0;transition:color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#9776;</button>
            <button id="btn-export-video" onclick="exportarVideoDirecto()" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--text-dim);font-size:0.58rem;padding:2px 6px;cursor:pointer;flex-shrink:0;white-space:nowrap;" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'">&#11015; Video</button>
            <button id="btn-cancel-export" onclick="cancelarExportacion()" style="display:none;background:none;border:1px solid var(--accent);border-radius:4px;color:var(--accent);font-size:0.58rem;padding:2px 6px;cursor:pointer;flex-shrink:0;white-space:nowrap;">&#10005; Cancelar</button>
            <button id="btn-fullscreen" onclick="toggleFullscreen()" style="background:none;border:none;color:var(--text-dim);font-size:0.9rem;cursor:pointer;padding:0 2px;flex-shrink:0;transition:color 0.2s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-dim)'">&#x26F6;</button>
            <button onclick="cerrarvideo()" style="background:none;border:none;color:var(--text-dim);font-size:1rem;cursor:pointer;padding:0 2px;flex-shrink:0;transition:color 0.2s;" onmouseover="this.style.color='#ff6b6b'" onmouseout="this.style.color='var(--text-dim)'">&#10005;</button>
        </div>

        <div id="video-index-panel">
            <div id="video-index-header">Capítulos</div>
            <div style="padding:6px 10px 8px;">
                <input type="text" id="video-index-search" placeholder="Buscar..." oninput="filtrarIndicevideo(this.value)">
            </div>
            <div id="video-index-list"></div>
        </div>

        <div id="video-translation-progress" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20;flex-direction:column;align-items:center;gap:10px;background:rgba(8,7,6,0.88);border:1px solid var(--border);border-radius:8px;padding:18px 28px;min-width:240px;">
            <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--accent2);">&#9203; Traduciendo...</span>
            <div style="width:100%;height:4px;background:var(--border);border-radius:4px;overflow:hidden;">
                <div id="ktl-fill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;transition:width 0.4s ease;"></div>
            </div>
            <span id="ktl-pct" style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--text-dim);">0%</span>
        </div>
    </div>

    <!-- ─── MODAL REEMPLAZOS ─── -->
    <div id="modal-reemplazos">
        <div class="modal-box">
            <div class="modal-header">
                <span>📋 Reemplazos activos al cargar capítulo</span>
                <button type="button" onclick="cerrarModalReemplazos()" title="Cerrar">✕</button>
            </div>
            <div class="modal-body" id="modal-reemplazos-body">
                <div class="modal-empty">No hay reemplazos guardados.</div>
            </div>
        </div>
    </div>

    <!-- ─── SCRIPTS ─── -->
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Librerías externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <!-- Estado global — debe cargarse primero -->
    <script src="js/main.js"></script>
    <!-- Módulos funcionales -->
    <script src="js/epub.js"></script>
    <script src="js/formats.js"></script>
    <script src="js/translation.js"></script>
    <script src="js/player.js"></script>
    <script src="js/tts.js"></script>
    <script src="js/video.js"></script>
    <!-- Imágenes web via Unsplash — carga después de player.js -->
    <script src="js/images.js"></script>
    <!-- Grabador de video — depende de tts.js, video.js, images.js -->
    <script src="js/export_video.js"></script>
    <script src="js/convert_mp4.js"></script>
    <script src="js/convert_mp3.js"></script>
    <script src="js/export_buttons.js"></script>
    <!-- UI: patches y helpers — debe cargarse último -->
    <script src="js/ui.js"></script>
    <!-- Auth — debe cargarse después de ui.js -->
    <script src="js/auth.js"></script>
    <script src="js/auth-ui.js"></script>
    <!-- Inicialización de UI — debe cargarse después de ui.js -->
    <script src="js/init.js"></script>
    <script>
        // ── Loop música ambiente ──────────────────────────────────────────
        window._ambientLoopOn = false;
        function toggleAmbientLoop() {
            window._ambientLoopOn = !window._ambientLoopOn;
            // Aplicar al elemento de audio ambiente — video.js puede exponerlo con distintos nombres
            const el = window.ambientAudio || window._ambientAudio || window._ambientEl
                || document.getElementById('ambient-audio');
            if (el) el.loop = window._ambientLoopOn;
            const btn = document.getElementById('kbtn-ambient-loop');
            if (btn) btn.style.color = window._ambientLoopOn ? 'var(--accent)' : 'var(--text-dim)';
            if (typeof mostrarNotificacion === 'function')
                mostrarNotificacion(window._ambientLoopOn ? '🔁 Loop música: ON' : '🔁 Loop música: OFF');
        }
    </script>


</body>
</html>