<!DOCTYPE html>
﻿
<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Lector EPUB con TTS</title>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&amp;family=DM+Mono:wght@400;500&amp;display=swap" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="notification" id="notification"></div>
    <!-- ─── MAIN PANEL ─── -->
    <div class="main-panel">
        <div class="top-bar">
            <h1>📚 Lector EPUB</h1>
            <button class="rec-btn" id="btn-rec-audio" onclick="toggleGrabacion()" type="button">
                <span id="rec-dot">⏺</span> Grabar audio
            </button>
            <button class="rec-btn s1" onclick="abrirvideo()" type="button">
                🎬 Modo Video
            </button>
            <button class="rec-btn" id="editor-toggle-btn" onclick="toggleEditor()" type="button">
                ✏️ Editor
            </button>
            <span class="subtitle" id="current-chapter-title">Ningún capítulo seleccionado</span>
        </div>
        <div class="stats-bar">
            <div class="stat">📝 Palabras: <strong id="contador-palabras">0</strong></div>
            <div class="stat">🔤 Chars: <strong id="contador-caracteres">0</strong></div>
            <div class="stat">📄 Párrafos: <strong id="contador-parrafos">0</strong></div>
            <div class="stat" id="tts-stat">⏹️ <strong id="tts-status">Detenido</strong></div>
        </div>
        <!-- ─── BARRA DE CONTROLES TTS ─── -->
        <div class="tts-control-bar">
            <div class="tts-bar-title">Ajustes del lector</div>
            <button class="btn-tts btn btn-tts-unified" id="btn-play" onclick="togglePlayPause()" type="button">▶</button>
            <button class="btn-tts btn" disabled="" id="btn-stop" onclick="detenerTTS()" type="button">⏹</button>
            <button disabled="" id="btn-pause" style="display:none;"></button>
            <button disabled="" id="btn-resume" style="display:none;"></button>
            <div class="tts-control-bar-sliders">
                <div class="tts-bar-slider">
                    <label>Velocidad <span id="rate-value">1.0</span>x</label>
                    <input id="rate-control" max="2.0" min="0.5" step="0.1" type="range" value="1.0" />
                </div>
                <div class="tts-bar-slider">
                    <label>Tono <span id="pitch-value">1.0</span></label>
                    <input id="pitch-control" max="2.0" min="0.5" step="0.1" type="range" value="1.0" />
                </div>
                <div class="tts-bar-slider">
                    <label>Volumen <span id="volume-value">100</span>%</label>
                    <input id="volume-control" max="100" min="0" step="5" type="range" value="100" />
                </div>
            </div>
            <select class="tts-bar-voice" id="voice-select"></select>
        </div>
        <div class="reading-area s2">
            <div id="texto-contenido">
                <p class="s3">Carga un archivo EPUB desde el panel lateral para comenzar a leer...</p>
            </div>
            <!-- Música ambiental flotante anclada a esquina inferior izquierda del reading area -->
        </div><!-- cierre reading-area -->
        <!-- ─── AMBIENT MUSIC PLAYER ─── -->
        <div class="collapsed" id="ambient-player">
            <div class="ambient-header" onclick="toggleAmbientPanel()">
                <div class="ambient-header-left">
                    <div class="ambient-eq" id="ambient-eq">
                        <span></span><span></span><span></span><span></span>
                    </div>
                    Música Ambiental
                </div>
                <button class="ambient-collapse-btn" id="ambient-arrow" type="button">▲</button>
            </div>
            <div class="ambient-body">
                <!-- API Key panel -->
                <div id="freesound-key-panel">
                    <div class="s4">
                        🎵 Freesound API Key <span id="key-status"></span>
                    </div>
                    <div class="s5" style="display:flex">
                        <input id="freesound-api-key" placeholder="Pegar API key..." type="password" />
                        <button class="s6" onclick="guardarApiKey()" type="button">
                            OK
                        </button>
                    </div>
                    <div class="s7">
                        Sin key → generador procedural local
                    </div>
                </div>
                <div class="ambient-genres">
                    <button class="genre-btn" id="genre-mystery" onclick="selectGenre('mystery')" type="button">
                        <span class="genre-icon">🔍</span>Misterio
                    </button>
                    <button class="genre-btn" id="genre-suspense" onclick="selectGenre('suspense')" type="button">
                        <span class="genre-icon">😰</span>Suspenso
                    </button>
                    <button class="genre-btn" id="genre-drama" onclick="selectGenre('drama')" type="button">
                        <span class="genre-icon">🎭</span>Drama
                    </button>
                    <button class="genre-btn" id="genre-action" onclick="selectGenre('action')" type="button">
                        <span class="genre-icon">⚡</span>Acción
                    </button>
                    <button class="genre-btn" id="genre-fantasy" onclick="selectGenre('fantasy')" type="button">
                        <span class="genre-icon">🧙</span>Fantasía
                    </button>
                    <button class="genre-btn" id="genre-romance" onclick="selectGenre('romance')" type="button">
                        <span class="genre-icon">💫</span>Romance
                    </button>
                    <button class="genre-btn" id="genre-lofi" onclick="selectGenre('lofi')" type="button">
                        <span class="genre-icon">📚</span>Lo-Fi
                    </button>
                    <button class="genre-btn" id="genre-nature" onclick="selectGenre('nature')" type="button">
                        <span class="genre-icon">🌿</span>Naturaleza
                    </button>
                </div>
                <button class="btn btn-secondary" id="btn-detect-genre" onclick="detectarGeneroConIA()" type="button">
                    ✨ Detectar género del texto
                </button>
                <div class="ambient-controls">
                    <button class="ambient-play-btn" id="ambient-play-btn" onclick="toggleAmbientPlay()" type="button">▶</button>
                    <div class="ambient-track-info">
                        <div class="ambient-track-name" id="ambient-track-name">Selecciona un género</div>
                        <div class="ambient-track-genre" id="ambient-track-genre">─</div>
                    </div>
                    <button class="s8" onclick="siguienteTrack()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'" title="Siguiente track" type="button">
                        ⏭
                    </button>
                </div>
                <div class="ambient-vol-row">
                    <span class="ambient-vol-icon">🎵</span>
                    <input id="ambient-volume" max="100" min="0" oninput="setAmbientVolume(this.value)" type="range" value="15" />
                    <span class="ambient-vol-val" id="ambient-vol-val">15%</span>
                </div>
            </div>
        </div><!-- cierre ambient-player -->
        <!-- Barra de procesamiento con fases — visible en el reading area al procesar -->
        <div id="main-processing-bar" style="display:none">
            <div class="s9" style="display:flex">
                <span id="mpb-label">Procesando...</span>
                <span id="mpb-pct">0%</span>
            </div>
            <!-- Barra unificada -->
            <div class="s10">
                <div id="mpb-fill"></div>
            </div>
            <!-- Indicadores de fase -->
            <div class="s11" style="display:flex">
                <span id="mpb-f1">① Traducción</span>
                <span id="mpb-f2">② Revisión</span>
                <span id="mpb-f3">③ Optimización</span>
            </div>
        </div>
        <div class="editor-panel" id="editor-panel">
            <div class="editor-inner">
                <div class="section-label">Editor de Texto</div>
<textarea id="editor-texto" placeholder="Pega aquí tu texto o edita el contenido actual..."></textarea>
                <div class="editor-actions">
                    <button class="btn btn-success" onclick="aplicarTexto()" type="button">Aplicar</button>
                    <button class="btn btn-secondary" onclick="limpiarEditor()" type="button">Limpiar</button>
                    <button class="btn btn-secondary" onclick="copiarTexto()" type="button">Copiar</button>
                    <button class="btn btn-secondary s12" onclick="traducirTextoActual()" type="button">Traducir</button>
                </div>
            </div>
        </div>
        <span id="tts-status-label" style="display:none;"></span>
        <div class="progress-wrap">
            <div class="progress-track" id="main-progress-track" onclick="seekTTS(event)" onmouseleave="mainProgressMouseLeave()" onmousemove="mainProgressMouseMove(event)">
                <div class="progress-fill" id="progress-fill"></div>
                <div id="main-progress-tooltip"></div>
            </div>
        </div>
    </div>
    <!-- ─── SIDEBAR ─── -->
    <div class="sidebar">
        <!-- Cargar EPUB -->
        <div class="sidebar-section">
            <div class="section-label">Archivo</div>
            <label class="file-label" for="epub-file">📂 Seleccionar EPUB</label>
            <input accept=".epub" id="epub-file" type="file" />
            <span id="file-name">Ningún archivo seleccionado</span>
        </div>
        <!-- Capítulos -->
        <div class="sidebar-section">
            <div class="section-label">Capítulos</div>
            <div id="chapter-selector" style="display:none;">
                <input id="chapter-search" oninput="filtrarCapitulos(this.value)" placeholder="🔍 Buscar capítulo..." type="text" />
                <select id="chapters" size="6">
                    <option disabled="">— sin capítulos —</option>
                </select>
            </div>
        </div>
        <!-- ═══════════════ AJUSTES ═══════════════ -->
        <div class="sidebar-section">
            <div class="section-label">Ajustes</div>
            <!-- ── Imágenes IA ── -->
            <div class="s13">
                <!-- ▶ Imágenes (nivel 1) -->
                <div class="collapsible-label s14" onclick="toggleImagenIAPanel()" style="display:flex">
                    🖼 Imágenes <span id="img-ia-arrow">▶</span>
                </div>
                <div id="imagen-ia-body" style="display:none">
                    <!-- ▶▶ Imágenes IA (nivel 2) -->
                    <div class="s15">
                        <div class="s16" onclick="toggleSubPanel('ia-options-body','ia-options-arrow')" style="display:flex">
                            🤖 Imágenes IA <span id="ia-options-arrow">▶</span>
                        </div>
                        <div id="ia-options-body" style="display:none">
                            <!-- Opciones (proveedores) -->
                            <div class="s17">
                                <div class="s18" onclick="toggleSubPanel('ia-prov-body','ia-prov-arrow')" style="display:flex">
                                    ⚙ Opciones <span id="ia-prov-arrow">▶</span>
                                </div>
                                <div id="ia-prov-body" style="display:none">
                                    <div class="s19" style="display:flex">
                                        <label class="s20" style="display:flex">
                                            <input checked="" id="prov-puter" name="img-provider" onchange="setImageProvider('puter')" type="radio" value="puter" />
                                            <span>Puter.js <span class="s21">(gratis)</span></span>
                                        </label>
                                        <label class="s22" style="display:flex">
                                            <input id="prov-stability" name="img-provider" onchange="setImageProvider('stability')" type="radio" value="stability" />
                                            <span>Stability AI <span class="s23">(key)</span></span>
                                        </label>
                                        <label class="s24" style="display:flex">
                                            <input id="prov-pollinations" name="img-provider" onchange="setImageProvider('pollinations')" type="radio" value="pollinations" />
                                            <span>Pollinations.AI <span class="s25">(gratis)</span></span>
                                        </label>
                                        <label class="s26" style="display:flex">
                                            <input id="prov-procedural" name="img-provider" onchange="setImageProvider('procedural')" type="radio" value="procedural" />
                                            <span>Procedural <span class="s27">(sin internet)</span></span>
                                        </label>
                                    </div>
                                    <div id="puter-panel">
                                        <div class="s28">Modelo Puter.js</div>
                                        <select id="puter-model" onchange="puterModel=this.value;localStorage.setItem('puter_model',this.value);">
                                            <optgroup label="── GPT Image ──"><option value="gpt-image-1.5">GPT Image 1.5 (recomendado)</option><option value="gpt-image-1">GPT Image 1</option><option value="dall-e-3">DALL-E 3</option></optgroup>
                                            <optgroup label="── FLUX ──"><option value="black-forest-labs/FLUX.1-schnell-Free">FLUX.1 Schnell</option><option value="black-forest-labs/FLUX.1-pro">FLUX.1 Pro</option><option value="black-forest-labs/FLUX.1.1-pro">FLUX.1.1 Pro</option><option value="black-forest-labs/FLUX.1-dev">FLUX.1 Dev</option></optgroup>
                                            <optgroup label="── Stable Diffusion ──"><option value="stabilityai/stable-diffusion-3-medium">SD3 Medium</option><option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL Base</option></optgroup>
                                            <optgroup label="── Otros ──"><option value="ideogram/ideogram-3.0">Ideogram 3.0</option><option value="grok-2-image">Grok 2 (xAI)</option><option value="google/imagen-4.0-fast">Imagen 4.0 Fast</option><option value="gemini-2.5-flash-image-preview">Gemini 2.5 Flash</option></optgroup>
                                        </select>
                                    </div>
                                    <div id="stability-panel" style="display:none;">
                                        <div class="s29">🔑 Stability Key <span id="stability-key-status"></span></div>
                                        <div class="s30" style="display:flex">
                                            <input id="stability-api-key" placeholder="sk-..." type="password" />
                                            <button class="s31" onclick="guardarStabilityKey()" type="button">OK</button>
                                        </div>
                                        <select id="stability-model" onchange="stabilityModel=this.value;localStorage.setItem('stability_model',this.value);">
                                            <option value="sd3.5-large">SD3.5 Large</option>
                                            <option value="sd3.5-large-turbo">SD3.5 Turbo</option>
                                            <option selected="" value="sd3.5-medium">SD3.5 Medium</option>
                                            <option value="core">Stable Image Core</option>
                                            <option value="ultra">Stable Image Ultra</option>
                                        </select>
                                    </div>
                                    <div id="pollinations-panel" style="display:none">Flux · Pollinations.AI — sin key</div>
                                    <div id="procedural-panel" style="display:none">Canvas 2D local — sin internet</div>
                                </div>
                            </div>
                            <!-- Modelos -->
                            <div>
                                <div class="s32" onclick="toggleSubPanel('ia-models-body','ia-models-arrow')" style="display:flex">
                                    🎨 Modelos <span id="ia-models-arrow">▶</span>
                                </div>
                                <div id="ia-models-body" style="display:none">
                                    <div class="s33">Selecciona el proveedor en Opciones para ver los modelos disponibles.</div>
                                </div>
                            </div>
                            <div id="img-ia-status-txt">Activa el visor y presiona 🖼 IA</div>
                        </div>
                    </div>
                    <!-- ▶▶ Imágenes web — Unsplash (nivel 2) -->
                    <div>
                        <div class="s34" onclick="toggleSubPanel('ia-web-body','ia-web-arrow')" style="display:flex">
                            🌐 Imágenes web <span id="ia-web-arrow">▶</span>
                        </div>
                        <div id="ia-web-body" style="display:none">
                            <!-- Badge de universo detectado -->
                            <div id="img-universe-badge" style="display:flex">
                                🌐 Universo: <span id="img-universe-label">—</span>
                            </div>
                            <!-- Barra de búsqueda custom -->
                            <div class="s35" style="display:flex">
                                <input id="img-search-input" placeholder="Buscar en Unsplash… o dejar vacío" type="text">
                                <button class="s36" onclick="ejecutarBusquedaImagenCustom()" type="button">
                                    🔍
                                </button>
                                </input>
                            </div>
                            <!-- Botón principal: generar según universo -->
                            <button class="s37" onclick="generarImagenesUniverso()" onmouseout="this.style.borderColor='var(--border)'" onmouseover="this.style.borderColor='var(--accent)'" type="button">
                                ✨ Generar por universo
                            </button>
                            <!-- Botón quitar fondo -->
                            <button class="s38" onclick="quitarImagenFondo()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--text)'" type="button">
                                ✕ Quitar fondo
                            </button>
                            <!-- Galería (gestionada por images.js) -->
                            <div id="imagen-ia-galeria"></div>
                            <!-- Atribución Unsplash -->
                            <div class="s39">
                                Imágenes via <a class="s40" href="https://unsplash.com?utm_source=epub_reader&amp;utm_medium=referral" rel="noopener" target="_blank">Unsplash</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- ── Traducción ── -->
            <div class="s41">
                <div class="toggle-row s42">
                    <span class="s43" style="display:flex">
                        <span>Traducción automática</span>
                        <span id="traduccion-lang-hint">→ detectando idioma...</span>
                    </span>
                    <label class="toggle">
                        <input id="auto-translate" onchange="marcarCambioPendiente()" type="checkbox" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <!-- Selector de idioma destino: todas las opciones que soporta el navegador -->
                <div class="s44">
                    <div class="s45">Traducir a:</div>
                    <select id="translation-lang-select" onchange="cambiarIdiomaTraduccion(this.value)">
                        <!-- Poblado por JS con los idiomas del navegador -->
                    </select>
                </div>
                <div id="translation-status">Traducción desactivada</div>
            </div>
            <!-- ── Naturalizar para TTS ── -->
            <div class="s46">
                <div class="toggle-row">
                    <span class="s47" style="display:flex">
                        <span>✨ Naturalizar para TTS</span>
                        <span id="humanizer-status">Desactivado</span>
                    </span>
                    <label class="toggle">
                        <input id="tts-humanizer" onchange="toggleTTSHumanizer()" type="checkbox" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div id="claude-key-panel" style="display:none">
                    <select id="humanizer-provider" onchange="cambiarProveedorHumanizer(this.value)">
                        <option value="perplexity">Perplexity AI (sonar)</option>
                        <option value="openai">OpenAI (gpt-4o-mini)</option>
                        <option value="anthropic">Anthropic (claude-haiku)</option>
                        <option value="gemini">Google Gemini (flash)</option>
                        <option value="groq">Groq (llama-3.3-70b)</option>
                        <option value="openrouter">OpenRouter (auto)</option>
                    </select>
                    <div class="s48">
                        🔑 API Key <span id="claude-key-status"></span>
                    </div>
                    <div class="s49" style="display:flex">
                        <input id="claude-api-key" placeholder="Pega tu API key..." type="password" />
                        <button class="s50" onclick="guardarClaudeApiKey()" type="button">
                            OK
                        </button>
                    </div>
                    <div id="humanizer-info">
                        Procesa ~2500 chars por bloque · puede tardar unos segundos
                    </div>
                </div>
            </div>
            <!-- ── Reproducir al terminar ── -->
            <div class="toggle-row" id="auto-play-row" style="display:none;">
                <span>▶ Reproducir al terminar</span>
                <label class="toggle">
                    <input checked="" id="auto-play-after-translate" onchange="marcarCambioPendiente()" type="checkbox" />
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- ── Auto siguiente capítulo ── -->
            <div class="toggle-row s51">
                <span class="s52" style="display:flex">
                    <span>⏭ Siguiente capítulo auto</span>
                    <span class="s53">Al terminar, carga el siguiente</span>
                </span>
                <label class="toggle">
                    <input checked="" id="auto-next-chapter" type="checkbox" />
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <!-- ── Botón Aplicar ── -->
            <div id="aplicar-row" style="display:none">
                <button id="btn-aplicar" onclick="aplicarConfiguracion()" type="button">
                    ✓ Aplicar
                </button>
                <div id="aplicar-hint">
                    Cambios pendientes — recarga el capítulo actual
                </div>
            </div>
        </div>
        <!-- Reemplazar palabras -->
        <div class="sidebar-section">
            <div class="section-label collapsible-label s54" onclick="toggleReemplazar()" style="display:flex">
                Reemplazar
                <span id="reemplazar-arrow">▶</span>
                <button class="s55" onclick="event.stopPropagation();abrirModalReemplazos()" onmouseout="this.style.color='var(--text-dim)';this.style.borderColor='var(--border)'" onmouseover="this.style.color='var(--accent)';this.style.borderColor='var(--accent)'" title="Ver reemplazos activos" type="button">
                    📋
                </button>
            </div>
            <div class="replace-pair" id="reemplazar-body" style="display:none;">
                <input id="palabra-buscar" placeholder="Buscar..." type="text" />
                <input id="palabra-reemplazar" placeholder="Reemplazar con..." type="text" />
                <div class="s56" style="display:flex">
                    <button class="btn btn-secondary" disabled="" id="btn-limpiar-reemplazos" onclick="limpiarReemplazosGuardados()" type="button">🗑 Limpiar</button>
                    <button class="btn btn-primary s57" onclick="reemplazarPalabra()" type="button">Reemplazar</button>
                </div>
                <div id="reemplazos-guardados-lista" style="display:none"></div>
            </div>
        </div>
    </div>
    <!-- ─── FOOTER ─── -->
    <footer class="app-footer">
        <span>© 2025 Lector EPUB</span>
        <span class="footer-sep">·</span>
        <span>Desarrollado por <strong class="s58">hpqode</strong></span>
        <span class="footer-sep">·</span>
        <a href="/cdn-cgi/l/email-protection#3141584545544353525a71565c50585d1f525e5c" title="Contacto por email">Email</a>
        <span class="footer-sep">·</span>
        <a href="https://wa.me/5493412282254" rel="noopener" target="_blank" title="WhatsApp">WhatsApp</a>
    </footer>
    <!-- ─── VIDEO OVERLAY ─── -->
    <div id="video-overlay">
        <div id="ai-bg-a"></div>
        <div id="ai-bg-b"></div>
        <div id="ai-bg-overlay"></div>
        <canvas id="video-canvas" style="display:block"></canvas>
        <div id="video-progress-wrap">
            <div id="video-progress-track" onclick="videoProgressSeek(event)" onmouseenter="this.style.height='8px'" onmouseleave="this.style.height='4px';videoProgressHover(false)" onmousemove="videoProgressMouseMove(event)">
                <div id="video-progress-fill"></div>
                <div id="video-seek-tooltip"></div>
            </div>
        </div>
        <div class="video-bar">
            <button id="kbtn-playpause" onclick="videoTogglePlay()">▶</button>
            <button class="s59" onclick="videoCapituloAnterior()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">⏮</button>
            <button class="s60" onclick="videoCapituloSiguiente()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">⏭</button>
            <span id="kp-current">—</span>
            <span id="kp-chapter"></span>
            <span class="s61" title="Volumen general">🔊</span>
            <input id="kol-tts-vol" max="100" min="0" oninput="setTTSVolume(this.value);document.getElementById('kol-tts-pct').textContent=this.value+'%'" type="range" value="100" />
            <span id="kol-tts-pct">100%</span>
            <button id="kbtn-ambient-mute" onclick="toggleAmbientMute()">🔊</button>
            <button id="kbtn-ambient-playpause" onclick="videoToggleAmbient()">▶</button>
            <button class="s62" onclick="videoMusicaPrev()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">◀</button>
            <span id="video-music-label">♬</span>
            <button class="s63" onclick="videoMusicaSiguiente()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">▶</button>
            <input id="kol-music-vol" max="100" min="0" oninput="setAmbientVolume(this.value);document.getElementById('kol-music-pct').textContent=this.value+'%';document.getElementById('ambient-vol-val').textContent=this.value+'%'" type="range" value="15" />
            <span id="kol-music-pct">15%</span>
            <button id="btn-toggle-ai-img" onclick="toggleAIImages()" onmouseout="if(!this.classList.contains('ai-active')){this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'}" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'">🖼 IA</button>
            <button id="btn-toggle-index" onclick="togglevideoIndex()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">☰</button>
            <button id="btn-export-video" onclick="exportarVideo()" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-dim)'" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'">⬇ Video</button>
            <button id="btn-cancel-export" onclick="cancelarExportacion()" style="display:none">✕ Cancelar</button>
            <button id="btn-fullscreen" onclick="toggleFullscreen()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='var(--accent)'">⛶</button>
            <button class="s64" onclick="cerrarvideo()" onmouseout="this.style.color='var(--text-dim)'" onmouseover="this.style.color='#ff6b6b'">✕</button>
        </div>
        <div id="video-index-panel">
            <div id="video-index-header">Capítulos</div>
            <div class="s65">
                <input id="video-index-search" oninput="filtrarIndicevideo(this.value)" placeholder="Buscar..." type="text" />
            </div>
            <div id="video-index-list"></div>
        </div>
        <div id="video-translation-progress" style="display:none">
            <span class="s66">⏳ Traduciendo...</span>
            <div class="s67">
                <div id="ktl-fill"></div>
            </div>
            <span id="ktl-pct">0%</span>
        </div>
    </div>
    <!-- ─── MODAL REEMPLAZOS ─── -->
    <div id="modal-reemplazos">
        <div class="modal-box">
            <div class="modal-header">
                <span>📋 Reemplazos activos al cargar capítulo</span>
                <button onclick="cerrarModalReemplazos()" title="Cerrar" type="button">✕</button>
            </div>
            <div class="modal-body" id="modal-reemplazos-body">
                <div class="modal-empty">No hay reemplazos guardados.</div>
            </div>
        </div>
    </div>
    <!-- ─── SCRIPTS ─── -->
    <!-- Librerías externas -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <!-- Estado global — debe cargarse primero -->
    <script src="js/main.js"></script>
    <!-- Módulos funcionales -->
    <script src="js/epub.js"></script>
    <script src="js/translation.js"></script>
    <script src="js/player.js"></script>
    <script src="js/tts.js"></script>
    <script src="js/video.js"></script>
    <!-- Imágenes web via Unsplash — carga después de player.js -->
    <script src="js/images.js"></script>
    <!-- UI: patches y helpers — debe cargarse último -->
    <script src="js/ui.js"></script>
</body>
</html>