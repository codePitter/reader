<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector EPUB con TTS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #0f0e0c;
            --surface: #1a1814;
            --surface2: #242018;
            --border: #2e2a22;
            --accent: #c8a96e;
            --accent2: #7eb89a;
            --text: #e8e0d0;
            --text-muted: #8a8070;
            --text-dim: #5a5248;
            --sidebar-w: 300px;
        }

        body {
            font-family: 'DM Mono', monospace;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* ─── MAIN CONTENT (LEFT 80%) ─── */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-right: 1px solid var(--border);
        }

        .top-bar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 28px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

            .top-bar h1 {
                font-family: 'Lora', serif;
                font-size: 1.15rem;
                font-weight: 600;
                color: var(--accent);
                letter-spacing: 0.02em;
            }

            .top-bar .subtitle {
                font-size: 0.7rem;
                color: var(--text-muted);
                margin-left: auto;
            }

        .stats-bar {
            display: flex;
            gap: 24px;
            padding: 8px 28px;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .stat {
            font-size: 0.65rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .stat strong {
                color: var(--accent);
                font-weight: 500;
            }

        /* Reading area */
        .reading-area {
            flex: 1;
            overflow-y: auto;
            padding: 48px 80px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

            .reading-area::-webkit-scrollbar {
                width: 4px;
            }

            .reading-area::-webkit-scrollbar-track {
                background: transparent;
            }

            .reading-area::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 2px;
            }

        #texto-contenido {
            font-family: 'Lora', serif;
            font-size: 1.1rem;
            line-height: 1.85;
            color: var(--text);
            max-width: 680px;
            margin: 0 auto;
        }

            #texto-contenido p {
                margin-bottom: 1.2em;
            }

        /* Progress bar at bottom of reading area */
        .progress-wrap {
            flex-shrink: 0;
            padding: 0 28px 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
        }

        .progress-track {
            height: 2px;
            background: var(--border);
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            width: 0%;
            transition: width 0.3s ease;
        }

        .tts-status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 8px 0;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .tts-percent-badge {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1px 8px;
            font-size: 0.6rem;
            color: var(--accent);
            font-weight: 500;
        }

        /* Editor panel (collapsible) */
        .editor-panel {
            flex-shrink: 0;
            background: var(--surface2);
            border-top: 1px solid var(--border);
            transition: max-height 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }

            .editor-panel.open {
                max-height: 260px;
            }

        .editor-inner {
            padding: 16px 28px;
        }

        #editor-texto {
            width: 100%;
            height: 130px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.78rem;
            padding: 12px;
            resize: vertical;
            outline: none;
            margin-bottom: 10px;
        }

            #editor-texto:focus {
                border-color: var(--accent);
            }

        .editor-actions {
            display: flex;
            gap: 8px;
        }

        /* ─── SIDEBAR (RIGHT) ─── */
        .sidebar {
            width: var(--sidebar-w);
            flex-shrink: 0;
            background: var(--surface);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

            .sidebar::-webkit-scrollbar {
                width: 3px;
            }

            .sidebar::-webkit-scrollbar-thumb {
                background: var(--border);
            }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

            .sidebar-section:last-child {
                border-bottom: none;
            }

        .section-label {
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .section-label::after {
                content: '';
                flex: 1;
                height: 1px;
                background: var(--border);
            }

        /* File upload */
        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 10px;
            background: var(--accent);
            color: var(--bg);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.72rem;
            font-weight: 500;
            letter-spacing: 0.03em;
            transition: opacity 0.2s;
        }

            .file-label:hover {
                opacity: 0.85;
            }

        input[type="file"] {
            display: none;
        }

        #file-name {
            display: block;
            font-size: 0.62rem;
            color: var(--text-dim);
            margin-top: 6px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chapter select */
        #chapters {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.7rem;
            padding: 4px;
            height: 110px;
            outline: none;
        }

            #chapters:focus {
                border-color: var(--accent);
            }

            #chapters option {
                padding: 4px 6px;
            }

                #chapters option:checked {
                    background: var(--accent);
                    color: var(--bg);
                }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

            .toggle-row span {
                font-size: 0.68rem;
                color: var(--text-muted);
            }

        .toggle {
            position: relative;
            width: 36px;
            height: 19px;
        }

            .toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .toggle-slider {
            position: absolute;
            inset: 0;
            background: var(--border);
            border-radius: 19px;
            cursor: pointer;
            transition: background 0.2s;
        }

            .toggle-slider::before {
                content: '';
                position: absolute;
                width: 13px;
                height: 13px;
                left: 3px;
                top: 3px;
                background: var(--text-muted);
                border-radius: 50%;
                transition: transform 0.2s, background 0.2s;
            }

        .toggle input:checked + .toggle-slider {
            background: var(--accent2);
        }

            .toggle input:checked + .toggle-slider::before {
                transform: translateX(17px);
                background: white;
            }

        #translation-status {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        /* Replace */
        .replace-pair {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* TTS Buttons */
        .tts-btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }

        /* Sliders */
        .slider-row {
            margin-bottom: 10px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.62rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

            .slider-label span {
                color: var(--accent);
            }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

            input[type="range"]::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--accent);
                cursor: pointer;
                transition: transform 0.15s;
            }

                input[type="range"]::-webkit-slider-thumb:hover {
                    transform: scale(1.3);
                }

        select#voice-select {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.65rem;
            padding: 6px 8px;
            outline: none;
            margin-bottom: 12px;
        }

            select#voice-select:focus {
                border-color: var(--accent);
            }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'DM Mono', monospace;
            font-size: 0.68rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: opacity 0.2s, transform 0.1s;
        }

            .btn:hover {
                opacity: 0.85;
            }

            .btn:active {
                transform: scale(0.97);
            }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }

        .btn-secondary {
            background: var(--surface2);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: var(--accent2);
            color: var(--bg);
        }

        .btn-tts {
            background: var(--surface2);
            color: var(--text);
            border: 1px solid var(--border);
            font-size: 0.65rem;
            padding: 7px 6px;
        }

            .btn-tts:disabled {
                opacity: 0.35;
                cursor: not-allowed;
                transform: none;
            }

            .btn-tts.active {
                background: var(--accent);
                color: var(--bg);
                border-color: var(--accent);
            }

        .btn-full {
            width: 100%;
        }

        /* Inputs */
        input[type="text"] {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.7rem;
            padding: 7px 10px;
            outline: none;
        }

            input[type="text"]:focus {
                border-color: var(--accent);
            }

            input[type="text"]::placeholder {
                color: var(--text-dim);
            }

        /* Notification */
        #notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text);
            font-family: 'DM Mono', monospace;
            font-size: 0.72rem;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

            #notification.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }

        /* Editor toggle button */
        .editor-toggle-btn {
            position: fixed;
            bottom: 24px;
            right: calc(var(--sidebar-w) + 24px);
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-family: 'DM Mono', monospace;
            font-size: 0.65rem;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 50;
            transition: all 0.2s;
        }

            .editor-toggle-btn:hover {
                border-color: var(--accent);
                color: var(--accent);
            }

        /* Scrollbar for reading area */
        .reading-area {
            scroll-behavior: smooth;
        }

        /* Highlight spoken word */
        .spoken {
            background: rgba(200, 169, 110, 0.18);
            border-radius: 2px;
        }

        /* TTS sentence highlight */
        .tts-sentence {
            border-radius: 3px;
            transition: background 0.25s ease, box-shadow 0.25s ease;
        }

            .tts-sentence.tts-active {
                background: rgba(200, 169, 110, 0.22);
                box-shadow: 0 0 0 2px rgba(200, 169, 110, 0.15);
                border-radius: 3px;
            }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .playing-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent2);
            animation: pulse 1s infinite;
            margin-right: 6px;
        }

        /* Responsive */
        @media (max-width: 700px) {
            :root {
                --sidebar-w: 240px;
            }

            .reading-area {
                padding: 32px 24px;
            }
        }

        /* ─── AMBIENT MUSIC PLAYER ─── */
        #ambient-player {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 260px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            z-index: 100;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

            #ambient-player.collapsed .ambient-body {
                display: none;
            }

        .ambient-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            cursor: pointer;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            user-select: none;
        }

        .ambient-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.68rem;
            color: var(--text-muted);
            font-family: 'DM Mono', monospace;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        .ambient-eq {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 12px;
        }

            .ambient-eq span {
                width: 3px;
                background: var(--accent2);
                border-radius: 1px;
                animation: none;
                height: 3px;
                transition: height 0.2s;
            }

            .ambient-eq.playing span:nth-child(1) {
                animation: eq1 0.8s ease-in-out infinite;
            }

            .ambient-eq.playing span:nth-child(2) {
                animation: eq2 0.6s ease-in-out infinite;
            }

            .ambient-eq.playing span:nth-child(3) {
                animation: eq3 1s ease-in-out infinite;
            }

            .ambient-eq.playing span:nth-child(4) {
                animation: eq2 0.7s ease-in-out infinite;
            }

        @keyframes eq1 {
            0%,100% {
                height: 3px
            }

            50% {
                height: 10px
            }
        }

        @keyframes eq2 {
            0%,100% {
                height: 6px
            }

            50% {
                height: 12px
            }
        }

        @keyframes eq3 {
            0%,100% {
                height: 9px
            }

            50% {
                height: 4px
            }
        }

        .ambient-collapse-btn {
            font-size: 0.6rem;
            color: var(--text-dim);
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
        }

        .ambient-body {
            padding: 14px;
        }

        .ambient-genres {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }

        .genre-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Mono', monospace;
            font-size: 0.58rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }

            .genre-btn:hover {
                border-color: var(--accent);
                color: var(--text);
            }

            .genre-btn.active {
                border-color: var(--accent2);
                background: rgba(126, 184, 154, 0.1);
                color: var(--accent2);
            }

            .genre-btn .genre-icon {
                font-size: 1rem;
            }

        .ambient-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .ambient-play-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--accent2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--bg);
            flex-shrink: 0;
            transition: transform 0.15s, opacity 0.15s;
        }

            .ambient-play-btn:hover {
                transform: scale(1.1);
            }

        .ambient-track-info {
            flex: 1;
            overflow: hidden;
        }

        .ambient-track-name {
            font-size: 0.6rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ambient-track-genre {
            font-size: 0.55rem;
            color: var(--text-dim);
        }

        .ambient-vol-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ambient-vol-icon {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .ambient-vol-row input[type=range] {
            flex: 1;
            height: 3px;
        }

        .ambient-vol-val {
            font-size: 0.6rem;
            color: var(--text-dim);
            width: 26px;
            text-align: right;
        }
    </style>
</head>
<body>

    <div id="notification" class="notification"></div>

    <!-- ─── MAIN PANEL ─── -->
    <div class="main-panel">
        <div class="top-bar">
            <h1>📚 Lector EPUB</h1>
            <span class="subtitle" id="current-chapter-title">Ningún capítulo seleccionado</span>
        </div>

        <div class="stats-bar">
            <div class="stat">📝 Palabras: <strong id="contador-palabras">0</strong></div>
            <div class="stat">🔤 Chars: <strong id="contador-caracteres">0</strong></div>
            <div class="stat">📄 Párrafos: <strong id="contador-parrafos">0</strong></div>
            <div class="stat" id="tts-stat" style="margin-left:auto;">⏹️ <strong id="tts-status">Detenido</strong></div>
        </div>

        <div class="reading-area">
            <div id="texto-contenido" style="font-family:'Lora',serif;font-size:1.1rem;line-height:1.85;color:var(--text);max-width:680px;margin:0 auto;">
                <p style="color:var(--text-dim);font-style:italic;">Carga un archivo EPUB desde el panel lateral para comenzar a leer...</p>
            </div>
        </div>

        <div class="editor-panel" id="editor-panel">
            <div class="editor-inner">
                <div class="section-label">Editor de Texto</div>
                <textarea id="editor-texto" placeholder="Pega aquí tu texto o edita el contenido actual..."></textarea>
                <div class="editor-actions">
                    <button class="btn btn-success" onclick="aplicarTexto()">Aplicar</button>
                    <button class="btn btn-secondary" onclick="limpiarEditor()">Limpiar</button>
                    <button class="btn btn-secondary" onclick="copiarTexto()">Copiar</button>
                    <button class="btn btn-secondary" onclick="traducirTextoActual()" style="margin-left:auto;">Traducir</button>
                </div>
            </div>
        </div>

        <div class="progress-wrap">
            <div class="tts-status-bar">
                <span id="tts-status-label">⏹ Sin reproducción</span>
                <span class="tts-percent-badge" id="tts-percent" style="display:none;">0%</span>
            </div>
            <div class="progress-track" onclick="seekTTS(event)">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div style="height:8px;"></div>
        </div>
    </div>

    <button class="editor-toggle-btn" onclick="toggleEditor()" id="editor-toggle-btn">✏️ Editor</button>

    <!-- ─── SIDEBAR ─── -->
    <div class="sidebar">

        <!-- Cargar EPUB -->
        <div class="sidebar-section">
            <div class="section-label">Archivo</div>
            <label for="epub-file" class="file-label">📂 Seleccionar EPUB</label>
            <input type="file" id="epub-file" accept=".epub">
            <span id="file-name">Ningún archivo seleccionado</span>
        </div>

        <!-- Capítulos -->
        <div class="sidebar-section">
            <div class="section-label">Capítulos</div>
            <div id="chapter-selector">
                <select id="chapters" size="6">
                    <option disabled>— sin capítulos —</option>
                </select>
            </div>
        </div>

        <!-- Traducción -->
        <div class="sidebar-section">
            <div class="section-label">Traducción</div>
            <div class="toggle-row">
                <span>Auto EN → ES</span>
                <label class="toggle">
                    <input type="checkbox" id="auto-translate" onchange="toggleAutoTranslate()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="translation-status">Traducción desactivada</div>
        </div>

        <!-- Reemplazar palabras -->
        <div class="sidebar-section">
            <div class="section-label collapsible-label" onclick="toggleReemplazar()" style="cursor:pointer;user-select:none;">
                Reemplazar <span id="reemplazar-arrow" style="margin-left:auto;font-size:0.7rem;color:var(--text-dim);">▶</span>
            </div>
            <div class="replace-pair" id="reemplazar-body" style="display:none;">
                <input type="text" id="palabra-buscar" placeholder="Buscar...">
                <input type="text" id="palabra-reemplazar" placeholder="Reemplazar con...">
                <button class="btn btn-primary" onclick="reemplazarPalabra()">Reemplazar</button>
            </div>
        </div>

        <!-- TTS Controles -->
        <div class="sidebar-section">
            <div class="section-label">Reproducción</div>
            <div class="tts-btn-grid">
                <button class="btn-tts btn" onclick="iniciarTTS()" id="btn-play">▶ Play</button>
                <button class="btn-tts btn" onclick="pausarTTS()" id="btn-pause" disabled>⏸ Pausa</button>
                <button class="btn-tts btn" onclick="reanudarTTS()" id="btn-resume" disabled>▶ Cont.</button>
                <button class="btn-tts btn" onclick="detenerTTS()" id="btn-stop" disabled>⏹ Stop</button>
            </div>

            <div class="section-label" style="margin-top:4px;">Voz</div>
            <select id="voice-select"></select>

            <div class="slider-row">
                <div class="slider-label">Velocidad <span id="rate-value">1.0</span>x</div>
                <input type="range" id="rate-control" min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="slider-row">
                <div class="slider-label">Tono <span id="pitch-value">1.0</span></div>
                <input type="range" id="pitch-control" min="0.5" max="2.0" step="0.1" value="1.0">
            </div>

            <div class="slider-row">
                <div class="slider-label">Volumen <span id="volume-value">100</span>%</div>
                <input type="range" id="volume-control" min="0" max="100" step="5" value="100">
            </div>
        </div>

    </div>

    <script src="js/main.js"></script>
    <script>
        // Reemplazar toggle
        function toggleReemplazar() {
            const body = document.getElementById('reemplazar-body');
            const arrow = document.getElementById('reemplazar-arrow');
            const open = body.style.display === 'none';
            body.style.display = open ? 'flex' : 'none';
            arrow.textContent = open ? '▼' : '▶';
        }

        // Editor toggle (UI only)
        function toggleEditor() {
            const panel = document.getElementById('editor-panel');
            const btn = document.getElementById('editor-toggle-btn');
            panel.classList.toggle('open');
            btn.textContent = panel.classList.contains('open') ? '✕ Cerrar Editor' : '✏️ Editor';
        }

        // Sync chapter title in top bar when chapter changes
        document.getElementById('chapters').addEventListener('change', function (e) {
            const opt = e.target.options[e.target.selectedIndex];
            if (opt) document.getElementById('current-chapter-title').textContent = opt.textContent;
        });

        // Patch actualizarEstadoTTS to also update the extra status elements in the new layout
        const _origActualizarEstadoTTS = actualizarEstadoTTS;
        // Wait for main.js to load first
        window.addEventListener('DOMContentLoaded', () => { });
    </script>

    <!-- ─── AMBIENT MUSIC PLAYER ─── -->
    <div id="ambient-player" class="collapsed">
        <div class="ambient-header" onclick="toggleAmbientPanel()">
            <div class="ambient-header-left">
                <div class="ambient-eq" id="ambient-eq">
                    <span></span><span></span><span></span><span></span>
                </div>
                Música Ambiental
            </div>
            <button class="ambient-collapse-btn" id="ambient-arrow">▲</button>
        </div>
        <div class="ambient-body">

            <!-- API Key panel -->
            <div id="freesound-key-panel" style="margin-bottom:10px;">
                <div style="font-size:0.58rem;color:var(--text-dim);margin-bottom:4px;">
                    🎵 Freesound API Key <span style="color:var(--accent2)" id="key-status"></span>
                </div>
                <div style="display:flex;gap:6px;">
                    <input type="password" id="freesound-api-key" placeholder="Pegar API key..."
                           style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;
                    color:var(--text);font-family:'DM Mono',monospace;font-size:0.62rem;padding:5px 8px;outline:none;">
                    <button onclick="guardarApiKey()"
                            style="background:var(--accent2);border:none;border-radius:4px;color:var(--bg);
                    font-family:'DM Mono',monospace;font-size:0.6rem;padding:5px 8px;cursor:pointer;">
                        OK
                    </button>
                </div>
                <div style="font-size:0.55rem;color:var(--text-dim);margin-top:3px;">
                    Sin key → generador procedural local
                </div>
            </div>

            <div class="ambient-genres">
                <button class="genre-btn" onclick="selectGenre('mystery')" id="genre-mystery">
                    <span class="genre-icon">🔍</span>Misterio
                </button>
                <button class="genre-btn" onclick="selectGenre('suspense')" id="genre-suspense">
                    <span class="genre-icon">😰</span>Suspenso
                </button>
                <button class="genre-btn" onclick="selectGenre('drama')" id="genre-drama">
                    <span class="genre-icon">🎭</span>Drama
                </button>
                <button class="genre-btn" onclick="selectGenre('action')" id="genre-action">
                    <span class="genre-icon">⚡</span>Acción
                </button>
                <button class="genre-btn" onclick="selectGenre('fantasy')" id="genre-fantasy">
                    <span class="genre-icon">🧙</span>Fantasía
                </button>
                <button class="genre-btn" onclick="selectGenre('romance')" id="genre-romance">
                    <span class="genre-icon">💫</span>Romance
                </button>
                <button class="genre-btn" onclick="selectGenre('lofi')" id="genre-lofi">
                    <span class="genre-icon">📚</span>Lo-Fi
                </button>
                <button class="genre-btn" onclick="selectGenre('nature')" id="genre-nature">
                    <span class="genre-icon">🌿</span>Naturaleza
                </button>
            </div>

            <button class="btn btn-secondary" onclick="detectarGeneroConIA()" id="btn-detect-genre"
                    style="width:100%;margin-bottom:10px;font-size:0.62rem;gap:6px;">
                ✨ Detectar género del texto
            </button>

            <div class="ambient-controls">
                <button class="ambient-play-btn" id="ambient-play-btn" onclick="toggleAmbientPlay()">▶</button>
                <div class="ambient-track-info">
                    <div class="ambient-track-name" id="ambient-track-name">Selecciona un género</div>
                    <div class="ambient-track-genre" id="ambient-track-genre">─</div>
                </div>
            </div>

            <div class="ambient-vol-row">
                <span class="ambient-vol-icon">🎵</span>
                <input type="range" id="ambient-volume" min="0" max="100" value="30" oninput="setAmbientVolume(this.value)">
                <span class="ambient-vol-val" id="ambient-vol-val">30%</span>
            </div>
        </div>
    </div>

    <script>
        // ─── AMBIENT MUSIC ENGINE — Web Audio API Procedural Generation ───
        // Genera música ambiental 100% en el navegador sin URLs externas

        let ambientCtx = null;
        let ambientNodes = [];
        let ambientPlaying = false;
        let ambientGenre = null;
        let ambientGainNode = null;
        let ambientVolume = 0.30;

        function getAudioCtx() {
            if (!ambientCtx) ambientCtx = new (window.AudioContext || window.webkitAudioContext)();
            return ambientCtx;
        }

        // ── Generadores por género ──
        const GENRE_GENERATORS = {

            mystery: (ctx, gain) => {
                // Notas oscuras lentas + reverb simulado
                const notes = [130.81, 155.56, 174.61, 196.00, 220.00];
                const nodes = [];
                notes.forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    g.gain.value = 0;
                    osc.connect(g); g.connect(gain);
                    osc.start();
                    // Pulsa cada nota con tiempo diferente
                    const interval = setInterval(() => {
                        const now = ctx.currentTime;
                        g.gain.setValueAtTime(0, now);
                        g.gain.linearRampToValueAtTime(0.08, now + 0.3);
                        g.gain.linearRampToValueAtTime(0, now + 2.5);
                    }, 3000 + i * 700);
                    nodes.push({ osc, interval });
                });
                // Rumble bajo
                const rumble = ctx.createOscillator();
                const rg = ctx.createGain();
                rumble.type = 'sine'; rumble.frequency.value = 55;
                rg.gain.value = 0.04;
                rumble.connect(rg); rg.connect(gain); rumble.start();
                nodes.push({ osc: rumble });
                return nodes;
            },

            suspense: (ctx, gain) => {
                const nodes = [];
                // Tremolo tense string simulation
                [220, 233, 246].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const lfo = ctx.createOscillator();
                    const lfoGain = ctx.createGain();
                    const g = ctx.createGain();
                    osc.type = 'sawtooth'; osc.frequency.value = freq;
                    lfo.type = 'sine'; lfo.frequency.value = 6 + i;
                    lfoGain.gain.value = 0.03;
                    g.gain.value = 0.04;
                    lfo.connect(lfoGain); lfoGain.connect(g.gain);
                    osc.connect(g); g.connect(gain);
                    osc.start(); lfo.start();
                    nodes.push({ osc }, { osc: lfo });
                });
                // Heartbeat-like bass
                const bass = ctx.createOscillator();
                const bg = ctx.createGain();
                bass.type = 'sine'; bass.frequency.value = 80;
                bg.gain.value = 0;
                bass.connect(bg); bg.connect(gain); bass.start();
                const beat = setInterval(() => {
                    const now = ctx.currentTime;
                    bg.gain.setValueAtTime(0, now);
                    bg.gain.linearRampToValueAtTime(0.12, now + 0.05);
                    bg.gain.linearRampToValueAtTime(0, now + 0.3);
                    bg.gain.setValueAtTime(0, now + 0.5);
                    bg.gain.linearRampToValueAtTime(0.08, now + 0.55);
                    bg.gain.linearRampToValueAtTime(0, now + 0.8);
                }, 1800);
                nodes.push({ osc: bass, interval: beat });
                return nodes;
            },

            drama: (ctx, gain) => {
                const nodes = [];
                // Slow cinematic pads
                [[261.63, 0.06], [329.63, 0.04], [392.00, 0.03], [493.88, 0.025]].forEach(([freq, vol]) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sine'; osc.frequency.value = freq;
                    g.gain.value = vol;
                    osc.connect(g); g.connect(gain); osc.start();
                    nodes.push({ osc });
                });
                // Slow filter sweep
                const noise = ctx.createOscillator();
                const ng = ctx.createGain();
                noise.type = 'triangle'; noise.frequency.value = 110;
                ng.gain.value = 0.05;
                noise.connect(ng); ng.connect(gain); noise.start();
                nodes.push({ osc: noise });
                return nodes;
            },

            action: (ctx, gain) => {
                const nodes = [];
                // Aggressive rhythm + brass-like hits
                const bassOsc = ctx.createOscillator();
                const bg = ctx.createGain();
                bassOsc.type = 'square'; bassOsc.frequency.value = 110;
                bg.gain.value = 0;
                bassOsc.connect(bg); bg.connect(gain); bassOsc.start();
                let beat = 0;
                const rhythm = [1, 0, 1, 0, 1, 1, 0, 1];
                const interval = setInterval(() => {
                    if (rhythm[beat % rhythm.length]) {
                        const now = ctx.currentTime;
                        bg.gain.setValueAtTime(0.1, now);
                        bg.gain.linearRampToValueAtTime(0, now + 0.15);
                    }
                    beat++;
                }, 200);
                nodes.push({ osc: bassOsc, interval });
                // High tension strings
                [440, 554, 659].forEach(freq => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sawtooth'; o.frequency.value = freq;
                    g.gain.value = 0.025;
                    o.connect(g); g.connect(gain); o.start();
                    nodes.push({ osc: o });
                });
                return nodes;
            },

            fantasy: (ctx, gain) => {
                const nodes = [];
                // Magical harp-like arpeggios
                const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25, 587.33, 659.25];
                let noteIdx = 0;
                const playNote = () => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = scale[noteIdx % scale.length];
                    g.gain.value = 0;
                    osc.connect(g); g.connect(gain); osc.start();
                    const now = ctx.currentTime;
                    g.gain.setValueAtTime(0, now);
                    g.gain.linearRampToValueAtTime(0.07, now + 0.05);
                    g.gain.linearRampToValueAtTime(0, now + 1.2);
                    setTimeout(() => osc.stop(), 1500);
                    noteIdx++;
                };
                const interval = setInterval(playNote, 400);
                nodes.push({ interval });
                // Pad underneath
                const pad = ctx.createOscillator();
                const pg = ctx.createGain();
                pad.type = 'sine'; pad.frequency.value = 130.81;
                pg.gain.value = 0.03;
                pad.connect(pg); pg.connect(gain); pad.start();
                nodes.push({ osc: pad });
                return nodes;
            },

            romance: (ctx, gain) => {
                const nodes = [];
                // Warm, slow piano-like notes
                const melody = [261.63, 329.63, 392.00, 329.63, 261.63, 293.66, 349.23, 293.66];
                let idx = 0;
                const interval = setInterval(() => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sine'; osc.frequency.value = melody[idx % melody.length];
                    g.gain.value = 0;
                    osc.connect(g); g.connect(gain); osc.start();
                    const now = ctx.currentTime;
                    g.gain.linearRampToValueAtTime(0.08, now + 0.1);
                    g.gain.linearRampToValueAtTime(0, now + 1.8);
                    setTimeout(() => osc.stop(), 2000);
                    // Armonía
                    const osc2 = ctx.createOscillator();
                    const g2 = ctx.createGain();
                    osc2.type = 'sine'; osc2.frequency.value = melody[idx % melody.length] * 1.5;
                    g2.gain.value = 0;
                    osc2.connect(g2); g2.connect(gain); osc2.start();
                    g2.gain.linearRampToValueAtTime(0.04, now + 0.15);
                    g2.gain.linearRampToValueAtTime(0, now + 1.5);
                    setTimeout(() => osc2.stop(), 1800);
                    idx++;
                }, 800);
                nodes.push({ interval });
                return nodes;
            },

            lofi: (ctx, gain) => {
                const nodes = [];
                // Lo-fi: muffled chords + vinyl crackle simulation
                const chords = [[261.63, 329.63, 392.00], [246.94, 311.13, 369.99], [220.00, 277.18, 329.63]];
                let ci = 0;
                const interval = setInterval(() => {
                    chords[ci % chords.length].forEach(freq => {
                        const osc = ctx.createOscillator();
                        const g = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        filter.type = 'lowpass'; filter.frequency.value = 800; // Muffled
                        osc.type = 'triangle'; osc.frequency.value = freq;
                        g.gain.value = 0;
                        osc.connect(filter); filter.connect(g); g.connect(gain); osc.start();
                        const now = ctx.currentTime;
                        g.gain.linearRampToValueAtTime(0.05, now + 0.1);
                        g.gain.linearRampToValueAtTime(0.04, now + 1.5);
                        g.gain.linearRampToValueAtTime(0, now + 2);
                        setTimeout(() => osc.stop(), 2200);
                    });
                    ci++;
                }, 2000);
                nodes.push({ interval });
                // Rain-like noise
                const bufferSize = ctx.sampleRate * 2;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * 0.015;
                const src = ctx.createBufferSource();
                src.buffer = buffer; src.loop = true;
                const nf = ctx.createBiquadFilter();
                nf.type = 'bandpass'; nf.frequency.value = 2000;
                src.connect(nf); nf.connect(gain); src.start();
                nodes.push({ src });
                return nodes;
            },

            nature: (ctx, gain) => {
                const nodes = [];
                // Wind + birds simulation
                // Wind: filtered noise
                const bufferSize = ctx.sampleRate * 3;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const wind = ctx.createBufferSource();
                wind.buffer = buffer; wind.loop = true;
                const wf = ctx.createBiquadFilter();
                wf.type = 'bandpass'; wf.frequency.value = 400; wf.Q.value = 0.5;
                const wg = ctx.createGain(); wg.gain.value = 0.08;
                wind.connect(wf); wf.connect(wg); wg.connect(gain); wind.start();
                nodes.push({ src: wind });
                // Bird chirps
                const chirp = () => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine';
                    o.frequency.setValueAtTime(2000 + Math.random() * 1000, ctx.currentTime);
                    o.frequency.linearRampToValueAtTime(2800 + Math.random() * 800, ctx.currentTime + 0.1);
                    g.gain.setValueAtTime(0, ctx.currentTime);
                    g.gain.linearRampToValueAtTime(0.04, ctx.currentTime + 0.02);
                    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.15);
                    o.connect(g); g.connect(gain); o.start();
                    setTimeout(() => o.stop(), 200);
                };
                const interval = setInterval(() => {
                    chirp();
                    if (Math.random() > 0.5) setTimeout(chirp, 150);
                }, 1500 + Math.random() * 3000);
                nodes.push({ interval });
                return nodes;
            }
        };

        const GENRE_LABELS = {
            mystery: 'Misterio oscuro', suspense: 'Suspenso tenso', drama: 'Drama cinematográfico',
            action: 'Acción intensa', fantasy: 'Fantasía mágica', romance: 'Romance suave',
            lofi: 'Lo-Fi + lluvia', nature: 'Naturaleza y viento'
        };

        // ── Freesound API key management ──
        let freesoundApiKey = localStorage.getItem('freesound_api_key') || '';

        function guardarApiKey() {
            const key = document.getElementById('freesound-api-key').value.trim();
            if (key) {
                freesoundApiKey = key;
                localStorage.setItem('freesound_api_key', key);
                document.getElementById('key-status').textContent = '✓ guardada';
                document.getElementById('freesound-api-key').value = '';
                setTimeout(() => document.getElementById('key-status').textContent = '', 2000);
            }
        }

        // Show key status on load
        window.addEventListener('DOMContentLoaded', () => {
            if (freesoundApiKey) {
                document.getElementById('key-status').textContent = '✓ configurada';
            }
        });

        // Freesound queries por género
        const FREESOUND_QUERIES = {
            mystery: 'dark mystery ambient cinematic',
            suspense: 'suspense tension thriller ambient',
            drama: 'emotional dramatic orchestral ambient',
            action: 'epic action intense cinematic',
            fantasy: 'magical fantasy ethereal ambient',
            romance: 'romantic soft piano ambient',
            lofi: 'lofi hip hop study chill',
            nature: 'nature forest birds ambient relaxing',
        };

        let freesoundTrackUrl = null;
        let freesoundAudio = null;

        async function buscarEnFreesound(genre) {
            if (!freesoundApiKey) return null;
            const query = encodeURIComponent(FREESOUND_QUERIES[genre]);
            const url = `https://freesound.org/apiv2/search/text/?query=${query}&filter=duration:[30+TO+300]+license:"Creative+Commons+0"&fields=name,previews,duration&page_size=15&token=${freesoundApiKey}`;
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    if (res.status === 401) { document.getElementById('key-status').textContent = '✗ key inválida'; }
                    return null;
                }
                const data = await res.json();
                if (data.results && data.results.length > 0) {
                    // Pick a random result from the top 15
                    const pick = data.results[Math.floor(Math.random() * data.results.length)];
                    return { url: pick.previews['preview-hq-mp3'], name: pick.name };
                }
            } catch (e) { console.warn('Freesound error:', e); }
            return null;
        }

        function toggleAmbientPanel() {
            const player = document.getElementById('ambient-player');
            const arrow = document.getElementById('ambient-arrow');
            player.classList.toggle('collapsed');
            arrow.textContent = player.classList.contains('collapsed') ? '▲' : '▼';
        }

        async function selectGenre(genre) {
            document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('genre-' + genre).classList.add('active');
            ambientGenre = genre;
            stopAmbient();
            document.getElementById('ambient-track-name').textContent = '⏳ Cargando...';
            document.getElementById('ambient-track-genre').textContent = freesoundApiKey ? 'buscando en Freesound...' : 'generador local';
            await playAmbient(genre);
        }

        async function playAmbient(genre) {
            const g = genre || ambientGenre;

            // Try Freesound first if key is available
            if (freesoundApiKey) {
                const track = await buscarEnFreesound(g);
                if (track) {
                    freesoundAudio = new Audio(track.url);
                    freesoundAudio.loop = true;
                    freesoundAudio.volume = ambientVolume;
                    freesoundAudio.crossOrigin = 'anonymous';
                    freesoundAudio.play().then(() => {
                        ambientPlaying = true;
                        document.getElementById('ambient-play-btn').textContent = '⏸';
                        document.getElementById('ambient-eq').classList.add('playing');
                        document.getElementById('ambient-track-name').textContent = track.name;
                        document.getElementById('ambient-track-genre').textContent = '♪ Freesound CC0';
                    }).catch(() => playAmbientLocal(g));
                    return;
                }
            }
            // Fallback: procedural
            playAmbientLocal(g);
        }

        function playAmbientLocal(genre) {
            const ctx = getAudioCtx();
            if (ctx.state === 'suspended') ctx.resume();
            ambientGainNode = ctx.createGain();
            ambientGainNode.gain.value = ambientVolume;
            ambientGainNode.connect(ctx.destination);
            const generator = GENRE_GENERATORS[genre || ambientGenre];
            if (!generator) return;
            ambientNodes = generator(ctx, ambientGainNode);
            ambientPlaying = true;
            document.getElementById('ambient-play-btn').textContent = '⏸';
            document.getElementById('ambient-eq').classList.add('playing');
            document.getElementById('ambient-track-name').textContent = GENRE_LABELS[genre];
            document.getElementById('ambient-track-genre').textContent = '♪ generado localmente';
        }

        function stopAmbient() {
            // Stop Freesound audio
            if (freesoundAudio) {
                freesoundAudio.pause();
                freesoundAudio.src = '';
                freesoundAudio = null;
            }
            // Stop procedural nodes
            ambientNodes.forEach(n => {
                try { if (n.osc) n.osc.stop(); } catch (e) { }
                try { if (n.src) n.src.stop(); } catch (e) { }
                if (n.interval) clearInterval(n.interval);
            });
            ambientNodes = [];
            if (ambientGainNode) {
                try { ambientGainNode.disconnect(); } catch (e) { }
                ambientGainNode = null;
            }
            ambientPlaying = false;
            document.getElementById('ambient-play-btn').textContent = '▶';
            document.getElementById('ambient-eq').classList.remove('playing');
        }

        function toggleAmbientPlay() {
            if (!ambientGenre) {
                document.getElementById('ambient-track-name').textContent = '← Elige un género primero';
                return;
            }
            if (ambientPlaying) { stopAmbient(); } else { playAmbient(ambientGenre); }
        }

        function setAmbientVolume(val) {
            ambientVolume = val / 100;
            document.getElementById('ambient-vol-val').textContent = val + '%';
            if (ambientGainNode) ambientGainNode.gain.value = ambientVolume;
            if (freesoundAudio) freesoundAudio.volume = ambientVolume;
        }

        function detectarGeneroLocal(texto) {
            const lower = texto.toLowerCase().slice(0, 2000);
            const scores = {
                mystery: ['misterio', 'oscuro', 'sombra', 'enigma', 'secreto', 'oculto', 'extraño', 'susurro', 'tinieblas', 'desapareci', 'cadáver', 'investigar', 'pista', 'crimen', 'muerto'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                suspense: ['tensión', 'peligro', 'trampa', 'amenaza', 'escapar', 'temor', 'miedo', 'acecho', 'perseguir', 'correr', 'tiempo', 'demasiado tarde', 'pistola', 'cuchillo'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                drama: ['llanto', 'lágrimas', 'dolor', 'sufrir', 'perder', 'traición', 'familia', 'amor roto', 'soledad', 'sacrificio', 'promesa', 'pasado', 'recuerdo', 'herida', 'culpa', 'perdón'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                action: ['combate', 'batalla', 'golpe', 'atacar', 'disparar', 'explotar', 'correr', 'saltar', 'luchar', 'espada', 'victoria', 'enemigo', 'guerrero', 'fuerza', 'velocidad', 'sangre'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                fantasy: ['magia', 'hechizo', 'dragón', 'reino', 'elfo', 'mago', 'destino', 'profecía', 'criatura', 'portal', 'poder antiguo', 'encantamiento', 'espíritu', 'legendario', 'runa'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                romance: ['amor', 'corazón', 'beso', 'mirada', 'suave', 'sentir', 'latir', 'ternura', 'abrazo', 'sonrisa', 'deseo', 'piel', 'suspirar', 'juntos', 'enamorar'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                lofi: ['estudiar', 'aprender', 'libro', 'notas', 'lección', 'conocimiento', 'teoría', 'análisis', 'investigación', 'datos', 'concepto', 'comprender', 'fórmula'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
                nature: ['bosque', 'árbol', 'río', 'montaña', 'viento', 'lluvia', 'animal', 'campo', 'flor', 'tierra', 'cielo', 'amanecer', 'naturaleza', 'verde', 'agua', 'pájaro'].reduce((s, w) => s + (lower.split(w).length - 1) * 2, 0),
            };
            return Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0];
        }

        async function detectarGeneroConIA() {
            const texto = document.getElementById('texto-contenido').textContent.trim();
            if (!texto || texto.length < 50) {
                document.getElementById('ambient-track-name').textContent = 'Carga un capítulo primero';
                return;
            }

            const btn = document.getElementById('btn-detect-genre');
            btn.textContent = '⏳ Analizando...';
            btn.disabled = true;

            // En localhost la API de Anthropic falla por CORS — usar análisis local
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

            if (!isLocalhost) {
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 60,
                            messages: [{ role: 'user', content: 'Analiza el siguiente fragmento y responde SOLO con una de estas palabras: mystery, suspense, drama, action, fantasy, romance, lofi, nature.\n\nTexto: "' + texto.slice(0, 600) + '"' }]
                        })
                    });
                    const data = await response.json();
                    const genreRaw = (data.content?.[0]?.text || '').trim().toLowerCase();
                    const validGenres = ['mystery', 'suspense', 'drama', 'action', 'fantasy', 'romance', 'lofi', 'nature'];
                    const genreIA = validGenres.find(g => genreRaw.includes(g));
                    if (genreIA) {
                        selectGenre(genreIA);
                        document.getElementById('ambient-track-name').textContent = '✨ ' + GENRE_LABELS[genreIA];
                        document.getElementById('ambient-track-genre').textContent = 'detectado por IA';
                        btn.textContent = '✨ Detectar género del texto';
                        btn.disabled = false;
                        return;
                    }
                } catch (e) { /* fallback */ }
            }

            // Análisis local por palabras clave
            const genreLocal = detectarGeneroLocal(texto);
            selectGenre(genreLocal);
            document.getElementById('ambient-track-name').textContent = '🔍 ' + GENRE_LABELS[genreLocal];
            document.getElementById('ambient-track-genre').textContent = isLocalhost ? 'análisis local (localhost)' : 'análisis local';

            btn.textContent = '✨ Detectar género del texto';
            btn.disabled = false;
        }
    </script>

</body>
</html>